<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Template Management - HadadaHealth</title>
  
  <!-- PWA Meta Tags -->
  <meta name="application-name" content="HadadaHealth">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="HadadaHealth">
  <meta name="description" content="Template management for healthcare reports">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#2D6356">
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/static/nav.css">
  <link rel="stylesheet" href="/static/css/template_customization.css">
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
  
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    
    .template-actions {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    
    .action-card {
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      height: 100%;
    }
    
    .action-card:hover {
      border-color: #2D6356;
      box-shadow: 0 4px 15px rgba(45, 99, 86, 0.15);
      transform: translateY(-2px);
    }
    
    .action-card i {
      font-size: 3rem;
      color: #2D6356;
      margin-bottom: 1rem;
    }
    
    .action-card h3 {
      color: #2D6356;
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    .action-card p {
      color: #6c757d;
      margin: 0;
      font-size: 0.95rem;
    }
    
    .templates-list {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    }
    
    .template-item {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .template-item:hover {
      border-color: #2D6356;
      box-shadow: 0 2px 10px rgba(45, 99, 86, 0.1);
    }
    
    .template-item h4 {
      color: #2D6356;
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    .template-meta {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    
    .template-meta i {
      width: 16px;
      margin-right: 0.5rem;
    }
    
    .template-actions-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .template-actions-buttons .btn {
      font-size: 0.85rem;
      padding: 0.4rem 0.8rem;
    }
    
    
    .stats-cards {
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      border-left: 4px solid #2D6356;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: #2D6356;
      margin-bottom: 0.5rem;
    }
    
    .stat-label {
      color: #6c757d;
      font-size: 0.95rem;
      font-weight: 500;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    
    /* Modal overrides for full-screen feel */
    .modal-xl {
      max-width: 95vw;
    }
    
    .modal-content {
      border: none;
      border-radius: 12px;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {      
      .action-card {
        margin-bottom: 1rem;
      }
      
      .template-actions-buttons {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div id="top-nav"></div>
  
  <div class="container">
    <!-- Page Title -->
    <div class="mt-4 mb-4">
      <h1><i class="fas fa-file-alt me-3"></i>Template Management</h1>
      <p class="text-muted">Create, customize, and manage report templates for your practice</p>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row stats-cards">
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-number" id="total-templates">0</div>
          <div class="stat-label">Total Templates</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-number" id="active-templates">0</div>
          <div class="stat-label">Active Templates</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-number" id="draft-templates">0</div>
          <div class="stat-label">Draft Templates</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-number" id="recent-usage">0</div>
          <div class="stat-label">Used This Week</div>
        </div>
      </div>
    </div>
    
    <!-- Action Cards -->
    <div class="template-actions">
      <h2 class="mb-4">Quick Actions</h2>
      <div class="row">
        <div class="col-md-4">
          <div class="action-card" onclick="openCreateTemplate()">
            <i class="fas fa-plus-circle"></i>
            <h3>Create New Template</h3>
            <p>Build a custom report template with various field types and AI integration</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="action-card" onclick="openTemplateLibrary()">
            <i class="fas fa-book-open"></i>
            <h3>Template Library</h3>
            <p>Browse and import pre-built templates from our healthcare library</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="action-card" onclick="openTemplateAnalytics()">
            <i class="fas fa-chart-bar"></i>
            <h3>Template Analytics</h3>
            <p>View usage statistics and performance metrics for your templates</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Templates List -->
    <div class="templates-list">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Your Templates</h2>
        <div class="d-flex gap-2">
          <div class="input-group" style="width: 300px;">
            <input type="text" class="form-control" placeholder="Search templates..." id="template-search">
            <button class="btn btn-outline-secondary" type="button">
              <i class="fas fa-search"></i>
            </button>
          </div>
          <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="fas fa-filter me-2"></i>Filter
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" data-filter="all">All Templates</a></li>
              <li><a class="dropdown-item" href="#" data-filter="active">Active Only</a></li>
              <li><a class="dropdown-item" href="#" data-filter="draft">Drafts Only</a></li>
              <li><a class="dropdown-item" href="#" data-filter="recent">Recently Used</a></li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- Templates will be loaded here -->
      <div id="templates-container">
        <div class="empty-state">
          <i class="fas fa-file-alt"></i>
          <h3>No Templates Yet</h3>
          <p>Create your first template to get started with automated report generation</p>
          <button class="btn btn-primary btn-lg mt-3" onclick="openCreateTemplate()">
            <i class="fas fa-plus me-2"></i>Create Your First Template
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Template Customization Modal (Full Content) -->
  <div id="template-customization-modal-container">
    <!-- Modal will be loaded dynamically -->
  </div>
  
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/template_customization.js"></script>
  <script src="/static/js/nav-bar.js"></script>

  <!-- Bottom Navigation for Mobile -->
  <div id="bottom-nav"></div>
  
  <script>
    // Template Management Page Controller
    class TemplateManagementPage {
      constructor() {
        this.templates = [];
        this.filteredTemplates = [];
        this.currentFilter = 'all';
        this.init();
      }
      
      async init() {
        console.log('üîß Initializing Template Management Page...');
        await this.loadTemplates();
        this.setupEventListeners();
        this.updateStats();
        console.log('‚úÖ Template Management Page initialized');
      }
      
      async loadTemplates() {
        try {
          console.log('üìã Loading templates...');
          const response = await fetch('/api/templates');
          if (response.ok) {
            this.templates = await response.json();
            this.filteredTemplates = [...this.templates];
            this.renderTemplates();
            console.log(`‚úÖ Loaded ${this.templates.length} templates`);
          } else {
            console.log('‚ÑπÔ∏è No templates found or API not available, using empty state');
            this.templates = [];
            this.filteredTemplates = [];
            this.renderEmptyState();
          }
        } catch (error) {
          console.log('‚ÑπÔ∏è Templates API not available, showing empty state');
          this.templates = [];
          this.filteredTemplates = [];
          this.renderEmptyState();
        }
      }
      
      setupEventListeners() {
        // Search functionality
        const searchInput = document.getElementById('template-search');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            this.filterTemplates(e.target.value, this.currentFilter);
          });
        }
        
        // Filter dropdown
        document.querySelectorAll('[data-filter]').forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            this.currentFilter = e.target.dataset.filter;
            this.filterTemplates(searchInput.value || '', this.currentFilter);
          });
        });
      }
      
      filterTemplates(searchTerm, filter) {
        let filtered = [...this.templates];
        
        // Apply search filter
        if (searchTerm) {
          filtered = filtered.filter(template => 
            template.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            template.description?.toLowerCase().includes(searchTerm.toLowerCase())
          );
        }
        
        // Apply category filter
        switch (filter) {
          case 'active':
            filtered = filtered.filter(template => template.status === 'active');
            break;
          case 'draft':
            filtered = filtered.filter(template => template.status === 'draft');
            break;
          case 'recent':
            // Filter templates used in last 7 days (mock logic)
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            filtered = filtered.filter(template => 
              new Date(template.last_used || template.updated_at) > weekAgo
            );
            break;
        }
        
        this.filteredTemplates = filtered;
        this.renderTemplates();
      }
      
      renderTemplates() {
        const container = document.getElementById('templates-container');
        
        if (this.filteredTemplates.length === 0) {
          this.renderEmptyState();
          return;
        }
        
        const templatesHtml = this.filteredTemplates.map(template => `
          <div class="template-item" data-template-id="${template.id}">
            <div class="row">
              <div class="col-md-8">
                <h4>${template.name}</h4>
                <p class="template-description">${template.description || 'No description provided'}</p>
                <div class="template-meta">
                  <span><i class="fas fa-tag"></i>Type: ${template.template_type}</span>
                  <span class="ms-3"><i class="fas fa-calendar"></i>Updated: ${this.formatDate(template.updated_at)}</span>
                  <span class="ms-3"><i class="fas fa-user"></i>Created by: ${template.created_by || 'Unknown'}</span>
                  <span class="ms-3">
                    <i class="fas fa-circle ${template.status === 'active' ? 'text-success' : 'text-warning'}"></i>
                    ${template.status || 'draft'}
                  </span>
                </div>
              </div>
              <div class="col-md-4 d-flex align-items-center justify-content-end">
                <div class="template-actions-buttons">
                  <button class="btn btn-sm btn-outline-primary" onclick="previewTemplate(${template.id})">
                    <i class="fas fa-eye"></i> Preview
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="editTemplate(${template.id})">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-outline-success" onclick="duplicateTemplate(${template.id})">
                    <i class="fas fa-copy"></i> Duplicate
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate(${template.id})">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
        container.innerHTML = templatesHtml;
      }
      
      renderEmptyState() {
        const container = document.getElementById('templates-container');
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-file-alt"></i>
            <h3>No Templates Found</h3>
            <p>Create your first template to get started with automated report generation</p>
            <button class="btn btn-primary btn-lg mt-3" onclick="openCreateTemplate()">
              <i class="fas fa-plus me-2"></i>Create Your First Template
            </button>
          </div>
        `;
      }
      
      updateStats() {
        const totalTemplates = this.templates.length;
        const activeTemplates = this.templates.filter(t => t.status === 'active').length;
        const draftTemplates = this.templates.filter(t => t.status === 'draft').length;
        const recentUsage = Math.floor(Math.random() * 10); // Mock data
        
        document.getElementById('total-templates').textContent = totalTemplates;
        document.getElementById('active-templates').textContent = activeTemplates;
        document.getElementById('draft-templates').textContent = draftTemplates;
        document.getElementById('recent-usage').textContent = recentUsage;
      }
      
      formatDate(dateString) {
        if (!dateString) return 'Unknown';
        return new Date(dateString).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }
    }
    
    // Global functions for template actions
    async function openCreateTemplate() {
      console.log('üîß Opening template creation modal...');
      await loadTemplateModal();
      
      // Show create tab
      const createTab = document.querySelector('#create-tab');
      if (createTab) {
        createTab.click();
      }
    }
    
    async function editTemplate(templateId) {
      console.log(`‚úèÔ∏è Opening template ${templateId} for editing...`);
      await loadTemplateModal();
      
      // Show edit tab and load template
      const editTab = document.querySelector('#edit-tab');
      if (editTab) {
        editTab.click();
        // Load the specific template for editing
        setTimeout(() => {
          const templateSelect = document.getElementById('templateSelect');
          if (templateSelect) {
            templateSelect.value = templateId;
            const loadBtn = document.getElementById('loadTemplateBtn');
            if (loadBtn) loadBtn.click();
          }
        }, 500);
      }
    }
    
    async function previewTemplate(templateId) {
      console.log(`üëÄ Previewing template ${templateId}...`);
      await loadTemplateModal();
      
      // Show preview tab
      const previewTab = document.querySelector('#preview-tab');
      if (previewTab) {
        previewTab.click();
      }
    }
    
    async function duplicateTemplate(templateId) {
      if (confirm('Create a copy of this template?')) {
        try {
          const response = await fetch(`/api/templates/${templateId}/duplicate`, {
            method: 'POST'
          });
          
          if (response.ok) {
            const result = await response.json();
            alert('Template duplicated successfully!');
            window.templatePage.loadTemplates(); // Refresh the list
          } else {
            alert('Error duplicating template');
          }
        } catch (error) {
          console.error('Error duplicating template:', error);
          alert('Error duplicating template. Please try again.');
        }
      }
    }
    
    async function deleteTemplate(templateId) {
      if (confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
        try {
          const response = await fetch(`/api/templates/${templateId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            alert('Template deleted successfully!');
            window.templatePage.loadTemplates(); // Refresh the list
          } else {
            alert('Error deleting template');
          }
        } catch (error) {
          console.error('Error deleting template:', error);
          alert('Error deleting template. Please try again.');
        }
      }
    }
    
    function openTemplateLibrary() {
      alert('Template Library feature coming soon! This will allow you to browse and import pre-built healthcare templates.');
    }
    
    function openTemplateAnalytics() {
      alert('Template Analytics feature coming soon! This will show usage statistics and performance metrics for your templates.');
    }
    
    // Load template modal HTML dynamically
    async function loadTemplateModal() {
      if (!document.getElementById('templateCustomizationModal')) {
        console.log('üì• Loading template customization modal HTML...');
        try {
          const response = await fetch('/static/fragments/template_customization_modal.html');
          const modalHtml = await response.text();
          
          const container = document.getElementById('template-customization-modal-container');
          container.innerHTML = modalHtml;
          
          console.log('‚úÖ Template customization modal HTML loaded');
        } catch (error) {
          console.error('‚ùå Error loading template modal:', error);
          alert('Error loading template interface. Please refresh the page.');
          return;
        }
      }
      
      // Open the modal
      const modalElement = document.getElementById('templateCustomizationModal');
      if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('‚úÖ Template customization modal opened');
      }
    }
    
    // Initialize page when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      window.templatePage = new TemplateManagementPage();
    });
  </script>
  
</body>
</html>