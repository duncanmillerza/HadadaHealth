<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Treatment Notes</title>
    <link rel="stylesheet" href="/static/forms.css">
    <link rel="stylesheet" href="/static/nav.css">
    <link rel="stylesheet" href="/static/css/outcome-measures.css">
    <link rel="preload" href="/static/fonts/MaterialIcons-Regular.woff2" as="font" type="font/ttf" crossorigin="anonymous">
</head>
<body>
  <script src="/static/js/nav-bar.js"></script>
  <div id="top-nav"></div>
    <div id="i3q7v4" class="form-section">
      <h1 id="treatment-heading" style="font-size: 1.8rem;">Treatment Notes</h1>
      <div id="appt-summary" style="color: #555; font-size: 0.95rem; margin-bottom: 1rem;"></div>
      <div class="section">
        <form onsubmit="submitTreatmentNote(event)" method="post" id="i7vw2d" class="treatment-form form-flex">
          <label>Subjective Findings<textarea name="subjective_findings" rows="3" id="i84xe9-2"></textarea></label>
          <label>Objective Findings<textarea name="objective_findings" rows="3" id="iazhsj-2"></textarea></label>
          <label>Treatment<textarea name="treatment" rows="3" id="i4sok2-2"></textarea></label>
          <label>Plan<textarea name="plan" rows="3" id="ig3tph-2"></textarea></label>
          <label class="toggle-group">Consent to Treatment
            <div class="switch-wrapper">
              <input type="checkbox" id="consent" name="consent" class="switch-checkbox">
              <span class="switch-slider"></span>
            </div>
          </label>

          <!-- Outcome Measures Section -->
          <div id="outcome-measures-section" class="outcome-measures-section" style="display: none; grid-column: 1 / -1; margin-top: 1rem;">
            <div class="section-header">
              <h3>📊 Outcome Measures</h3>
            </div>
            <div id="outcome-measures-list" class="outcomes-list">
              <!-- Outcome measures will be populated here -->
            </div>
          </div>

          <!-- Existing Billing Codes Display -->
          <div id="existing-billing-codes" style="margin-top:1rem; display:none;">
            <h3>Existing Billing Codes</h3>
            <ul id="billing-codes-list"></ul>
          </div>

          <button type="button" id="show-billing-button" onclick="showBillingSection()">Add Billing</button>
          <div id="billing-section" style="display:none; margin-top: 2rem; width: 100%; grid-column: 1 / -1;">
            <h3>Billing</h3>
            <table class="billing-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Description</th>
                  <th>Number</th>
                  <th>Modifier</th>
                  <th>Rate</th>
                  <th>Total</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="billing-table-body">
                <tr class="billing-entry">
                  <td>
                    <input name="code_id[]" list="billing-codes-datalist" placeholder="Start typing code" oninput="populateBillingRow(this)">
                  </td>
                  <td class="description-cell">—</td>
                  <td>
                    <input type="number" name="number[]" value="1" min="1" onchange="recalculateTotal(this)">
                  </td>
                  <td>
                    <select name="billing_modifier[]" onchange="applyModifier(this)">
                      <option value="">None</option>
                    </select>
                  </td>
                  <td class="rate-cell">—</td>
                  <td class="total-cell">—</td>
                  <td>
                    <button type="button" onclick="removeBillingRow(this)">✕</button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div id="billing-total" style="margin-top: 1rem; font-weight: bold; text-align: right;">
              Total: R<span id="overall-total">0.00</span>
            </div>
            <datalist id="billing-codes-datalist"></datalist>
            <button type="button" onclick="addBillingRow()">+ Add Code</button>
          </div>

          <!-- Backdrop for menu overlay -->
          <div id="menu-backdrop" class="menu-backdrop" onclick="closeElementsMenu()"></div>
          
          <!-- Plus button for adding treatment note elements -->
          <div class="add-elements-section" style="margin-top: 1rem; margin-bottom: 1rem; position: relative;">
          <button type="button" id="add-elements-btn" onclick="toggleElementsMenu()" style="
            background: #2D6356; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            font-size: 24px; 
            cursor: pointer; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem auto;
          ">+</button>
          
          <!-- Elements menu (initially hidden) -->
          <div id="elements-menu" style="
            display: none;
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            padding: 1rem;
            max-width: 400px;
            min-width: 350px;
            z-index: 1000;
          ">
            <h3 style="margin: 0 0 1rem 0; color: #333; text-align: center;">Add Elements</h3>
            <div class="elements-grid" style="
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 0.5rem;
            ">
              <button type="button" class="element-btn" onclick="addOutcomeMeasures()" style="
                padding: 0.75rem;
                border: 1px solid #ddd;
                border-radius: 6px;
                background: white;
                cursor: pointer;
                text-align: center;
                transition: background-color 0.2s;
              ">
                <span class="material-icons" style="display: block; font-size: 24px; margin-bottom: 0.25rem;">bar_chart</span>
                Outcome Measures
              </button>
              
              <button type="button" class="element-btn" onclick="addReminders()" style="
                padding: 0.75rem;
                border: 1px solid #ddd;
                border-radius: 6px;
                background: white;
                cursor: pointer;
                text-align: center;
                transition: background-color 0.2s;
              ">
                <span class="material-icons" style="display: block; font-size: 24px; margin-bottom: 0.25rem;">schedule</span>
                Reminders
              </button>
              
              <button type="button" class="element-btn" onclick="addGoals()" style="
                padding: 0.75rem;
                border: 1px solid #ddd;
                border-radius: 6px;
                background: white;
                cursor: pointer;
                text-align: center;
                transition: background-color 0.2s;
              ">
                <span class="material-icons" style="display: block; font-size: 24px; margin-bottom: 0.25rem;">flag</span>
                Goals
              </button>
              
              <button type="button" class="element-btn" onclick="addEquipment()" style="
                padding: 0.75rem;
                border: 1px solid #ddd;
                border-radius: 6px;
                background: white;
                cursor: pointer;
                text-align: center;
                transition: background-color 0.2s;
              ">
                <span class="material-icons" style="display: block; font-size: 24px; margin-bottom: 0.25rem;">build</span>
                Equipment
              </button>
              
              <button type="button" class="element-btn" onclick="addPatientMessage()" style="
                padding: 0.75rem;
                border: 1px solid #ddd;
                border-radius: 6px;
                background: white;
                cursor: pointer;
                text-align: center;
                transition: background-color 0.2s;
              ">
                <span class="material-icons" style="display: block; font-size: 24px; margin-bottom: 0.25rem;">message</span>
                Message Patient
              </button>
              
              <button type="button" class="element-btn" onclick="addTeamAlert()" style="
                padding: 0.75rem;
                border: 1px solid #ddd;
                border-radius: 6px;
                background: white;
                cursor: pointer;
                text-align: center;
                transition: background-color 0.2s;
              ">
                <span class="material-icons" style="display: block; font-size: 24px; margin-bottom: 0.25rem;">warning</span>
                Team Alert
              </button>
              
              <button type="button" class="element-btn" onclick="addUploads()" style="
                padding: 0.75rem;
                border: 1px solid #ddd;
                border-radius: 6px;
                background: white;
                cursor: pointer;
                text-align: center;
                transition: background-color 0.2s;
              ">
                <span class="material-icons" style="display: block; font-size: 24px; margin-bottom: 0.25rem;">cloud_upload</span>
                Uploads
              </button>
            </div>
          </div>
        </div>


          <button type="submit">Submit Note</button>
        </form>
        
      </div>
    </div>
    <script src="/static/js/nav-bar.js"></script>
    <script src="/static/js/outcome-measures.js"></script>
    <div id="bottom-nav"></div>
    <script>
      let therapistName = '';
      let therapistId = '';

      async function submitTreatmentNote(event) {
        event.preventDefault();

        const form = document.getElementById("i7vw2d");
        const formData = new FormData(form);
        const params = new URLSearchParams(window.location.search);
        const bookingId = params.get("booking_id");

        // Check if billing section is visible
        const billingSectionVisible = document.getElementById("billing-section").style.display !== "none";
        // Gather billing data only if billing section is visible and at least one code is entered
        let billingEntries = [];
        if (billingSectionVisible) {
          const billingRows = document.querySelectorAll("#billing-table-body .billing-entry");
          billingEntries = Array.from(billingRows)
            .map(row => ({
              code_id: row.querySelector("input[name='code_id[]']").value.split(" - ")[0],
              billing_modifier: row.querySelector("select[name='billing_modifier[]']").value || "",
              final_fee: parseFloat(row.querySelector(".total-cell").textContent) || 0
            }))
            .filter(entry => entry.code_id && entry.code_id.trim().length > 0);
        }

        // Prepare treatment note payload
        const payload = {
          appointment_id: bookingId,
          appointment_date: document.getElementById("appt-summary").textContent.split("•")[0].trim(),
          start_time: document.getElementById("appt-summary").textContent.split("•")[1].trim(),
          duration: parseInt(document.getElementById("appt-summary").textContent.split("•")[2]) || 0,
          patient_name: document.getElementById("treatment-heading").textContent.split(" - ")[0],
          patient_id: appt.patient_id,  // use actual patient_id from the appointment object
          profession: currentProfession || "",
          therapist_name: therapistName || "",
          therapist_id: therapistId || "",
          subjective_findings: formData.get("subjective_findings"),
          objective_findings: formData.get("objective_findings"),
          treatment: formData.get("treatment"),
          plan: formData.get("plan"),
          note_to_patient: "", // Required field - currently no form input for this
          consent_to_treatment: formData.get("consent") ? "Yes" : "No"
        };

        try {
          let billingSubmitted = false;
          // Only build and submit billing payload if section is visible and at least one code is entered
          if (billingSectionVisible && billingEntries.length > 0) {
            // 1. Before billingPayload: debug log
            console.log("Preparing billing submission");
            // Safeguard for appt before building billingPayload
            if (!appt) {
              console.warn("❌ No appointment data found. Skipping billing submission.");
              return;
            }
            const billingPayload = {
              session: {
                id: bookingId,
                patient_id: appt.patient_id,
                therapist_id: therapistId,
                session_date: appt?.date || new Date().toISOString().split("T")[0],
                notes: formData.get("treatment") || "",
                
              },
              entries: billingEntries
            };
            // 2. After billingPayload: debug log
            console.log("Billing payload:", billingPayload);
            // 3. Before fetch: debug log
            console.log("Sending billing data to /billing-sessions...");
            const billingRes = await fetch("/billing-sessions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify(billingPayload)
            });
            // 4. After fetch: debug log
            console.log("Billing response status:", billingRes.status);

            if (!billingRes.ok) throw new Error("Failed to save billing");
            billingSubmitted = true;
          } else {
            console.log("Billing section hidden or no billing entries; skipping billing submission.");
          }

          // Now submit treatment note
          const response = await fetch("/submit-treatment-note", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) throw new Error("Failed to save treatment note");

          // Success: show notification
          if (billingSubmitted) {
            showToast("Billing submitted successfully.", "#2D6356");
          }
          showToast("Treatment note saved successfully.", "#32517A");
          // After success, go back after 3 seconds
          setTimeout(() => {
            history.back();
          }, 3000);
        } catch (err) {
          console.error("Error saving treatment note:", err);
          alert("Error saving treatment note.");
        }
      }
    </script>
    <script>
      function addBillingRow() {
        const row = document.querySelector(".billing-entry").cloneNode(true);
        row.querySelectorAll("input").forEach(input => {
          if (input.type !== "number") input.value = "";
        });
        row.querySelector(".description-cell").textContent = "—";
        row.querySelector(".rate-cell").textContent = "—";
        row.querySelector(".total-cell").textContent = "—";
        document.getElementById("billing-table-body").appendChild(row);
        loadModifiers(row.querySelector("select[name='billing_modifier[]']"));
      }

      function removeBillingRow(button) {
        const row = button.closest("tr");
        const table = document.getElementById("billing-table-body");
        if (table.rows.length > 1) table.removeChild(row);
      }

      async function populateBillingRow(input) {
        const codeInput = input.value.split(" - ")[0];
        try {
          const response = await fetch("/api/billing-codes");
          const codes = await response.json();
          const match = codes.find(c => c.code === codeInput);
          if (match) {
            const row = input.closest("tr");
            row.dataset.baseRate = match.base_fee;
            row.querySelector(".description-cell").textContent = match.description;
            row.querySelector(".rate-cell").textContent = match.base_fee.toFixed(2);
            const quantity = parseInt(row.querySelector("input[name='number[]']").value) || 1;
            row.querySelector(".total-cell").textContent = (match.base_fee * quantity).toFixed(2);
            updateOverallTotal();
          }
        } catch (err) {
          console.error("Error populating billing row:", err);
        }
      }

      async function loadModifiers(selectElement) {
        try {
          // Use currentProfession if available, otherwise fallback to no filter
          const response = await fetch(`/api/billing_modifiers?profession=${encodeURIComponent(currentProfession || "")}`);
          const billing_modifiers = await response.json();
          billing_modifiers.forEach(mod => {
            const option = document.createElement("option");
            // Use modifier_code and modifier_description for value/text
            option.value = mod.modifier_code;
            option.textContent = `${mod.modifier_code} - ${mod.modifier_description}`;
            // Use modifier_multiplier as the adjustment factor
            option.dataset.factor = mod.modifier_multiplier;
            selectElement.appendChild(option);
          });
        } catch (err) {
          console.error("Failed to load billing_modifiers", err);
        }
      }

      function applyModifier(select) {
        const row = select.closest("tr");
        const baseRate = parseFloat(row.dataset.baseRate || 0);
        const factor = parseFloat(select.selectedOptions[0].dataset.factor || 1);
        const adjustedRate = baseRate * factor;
        row.querySelector(".rate-cell").textContent = adjustedRate.toFixed(2);

        const quantity = parseInt(row.querySelector("input[name='number[]']").value) || 1;
        row.querySelector(".total-cell").textContent = (adjustedRate * quantity).toFixed(2);

        updateOverallTotal();
      }

      function recalculateTotal(input) {
        const row = input.closest("tr");
        const rateText = row.querySelector(".rate-cell").textContent;
        const rate = parseFloat(rateText);
        const quantity = parseInt(input.value) || 1;
        if (!isNaN(rate)) {
          row.querySelector(".total-cell").textContent = (rate * quantity).toFixed(2);
        }
        updateOverallTotal();
      }

// Apply Modifier Rule 008 (50% additional procedure)
function applyModifierRule008(skipUpdateTotal) {
  // Only apply this rule for physiotherapy
  if (currentProfession.toLowerCase() !== "physiotherapy") {
    return; // Only apply this rule for physiotherapy
  }
  const rows = document.querySelectorAll("#billing-table-body .billing-entry");
  const rateMap = [];

  rows.forEach(row => {
    const codeInput = row.querySelector("input[name='code_id[]']").value;
    const baseRate = parseFloat(row.dataset.baseRate || 0);
    const code = codeInput.split(" - ")[0].trim();
    rateMap.push({ row, code, baseRate });
  });

  // Sort by baseRate descending
  rateMap.sort((a, b) => b.baseRate - a.baseRate);

  const excludedCodes = [
    "72407", "72501", "72502", "72503", "72507", "72508", "72509",
    "72701", "72702", "72703", "72704", "72705", "72706", "72707", "72708",
    "72720", "72721", "72801", "72803", "72901", "72903"
  ];

  // Identify the first major procedure that is not excluded
  let majorProcedureIndex = rateMap.findIndex(entry => !excludedCodes.includes(entry.code));
  if (majorProcedureIndex === -1) majorProcedureIndex = 0; // fallback to first

  for (let i = 0; i < rateMap.length; i++) {
    const { row, code, baseRate } = rateMap[i];

    // Skip the major procedure (first non-excluded)
    if (i === majorProcedureIndex) continue;

    if (!excludedCodes.includes(code)) {
      const rateCell = row.querySelector(".rate-cell");
      const totalCell = row.querySelector(".total-cell");
      const quantity = parseInt(row.querySelector("input[name='number[]']").value) || 1;
      const modifiedRate = baseRate * 0.5;

      rateCell.textContent = modifiedRate.toFixed(2);
      totalCell.textContent = (modifiedRate * quantity).toFixed(2);

      const modifierSelect = row.querySelector("select[name='billing_modifier[]']");
      if (modifierSelect && ![...modifierSelect.options].some(o => o.value === "0008")) {
        const option = document.createElement("option");
        option.value = "0008";
        option.textContent = "0008 - 50% additional procedure";
        modifierSelect.appendChild(option);
      }
      modifierSelect.value = "0008";
    }
  }
  updateOverallTotal(true);
}

function updateOverallTotal(skipRule008 = false) {
  const totalCells = document.querySelectorAll(".total-cell");
  let sum = 0;
  totalCells.forEach(cell => {
    const value = parseFloat(cell.textContent);
    if (!isNaN(value)) sum += value;
  });
  document.getElementById("overall-total").textContent = sum.toFixed(2);

  if (!skipRule008) {
    applyModifierRule008(true);
  }
}
    </script>
    <script>
      // Store profession for later use
      let currentProfession = '';

      document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const bookingId = params.get("booking_id");
        if (!bookingId) return;

        try {
          const res = await fetch(`/bookings/${bookingId}`);
          const appt = await res.json();
          window.appt = appt;  // make the booking data available globally

          const dateStr = new Date(appt.date).toLocaleDateString();
          const timeStr = appt.time || "Unknown";
          const durationStr = `${appt.duration || 0} minutes`;

          const heading = document.getElementById("treatment-heading");
          heading.textContent = `${appt.name || "Patient"} - ${appt.profession || ""} Notes`;

          const summary = document.getElementById("appt-summary");
          summary.textContent = `${dateStr} • ${timeStr} • ${durationStr}`;

          currentProfession = appt.profession || '';
          therapistName = appt.therapist || '';
          therapistId = appt.therapist_id ? String(appt.therapist_id) : '';
          populateBillingCodes(); // ensure profession is available before loading codes

          // Fetch and display existing billing codes for this appointment
          try {
            const billingRes = await fetch(`/billing-sessions/${appt.patient_id}`);
            const billingSessions = await billingRes.json();
            const session = billingSessions.find(s => String(s.id) === String(bookingId));
            if (session && session.entries && session.entries.length) {
              const container = document.getElementById("existing-billing-codes");
              const list = document.getElementById("billing-codes-list");
              list.innerHTML = "";
              session.entries.forEach(e => {
                const li = document.createElement("li");
                li.textContent = `${e.code_id} - ${e.billing_modifier || "No Modifier"} - R${e.final_fee}`;
                list.appendChild(li);
              });
              container.style.display = "block";
            }
          } catch (err) {
            // Fail silently, do not block page
            console.warn("Could not load existing billing codes:", err);
          }

          // Load existing outcome measures for this treatment note
          await loadExistingOutcomeMeasures(bookingId);
          
        } catch (err) {
          console.error("Failed to fetch appointment", err);
        }
        // Populate modifiers for all existing modifier selects
        document.querySelectorAll("select[name='billing_modifier[]']").forEach(loadModifiers);
      });
    </script>
    <script>
      async function addBillingCode() {
        const container = document.getElementById('billing-codes');
        const entry = document.createElement('div');
        entry.className = 'billing-entry';
        entry.innerHTML = `
          <input name="code_id[]" list="billing-codes-datalist" placeholder="Start typing code or description">
          <input type="text" name="billing_modifier[]" placeholder="Modifier (optional)" />
        `;
        container.appendChild(entry);
        await populateBillingCodes();
      }

      async function populateBillingCodes() {
        if (!currentProfession) return;
        try {
          const response = await fetch(`/api/billing-codes?profession=${encodeURIComponent(currentProfession)}`);
          const codes = await response.json();
          const datalist = document.getElementById("billing-codes-datalist");
          datalist.innerHTML = ""; // clear previous

          codes.forEach(code => {
            const option = document.createElement("option");
            const truncatedDesc = code.description.length > 50 ? code.description.slice(0, 50) + '...' : code.description;
            option.value = `${code.code} - ${truncatedDesc}`;
            datalist.appendChild(option);
          });
        } catch (err) {
          console.error("Failed to load billing codes", err);
        }
      }
    </script>
    <div id="toast-container" style="position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%);
      display: flex; flex-direction: column; gap: 0.5rem; align-items: center; z-index: 9999;"></div>

    <!-- Outcome Measure Modal -->
    <style>
      /* Plus button hover and transitions */
      #add-elements-btn {
        transition: all 0.3s ease !important;
      }
      
      #add-elements-btn:hover {
        background: #24523b !important;
        transform: scale(1.05) !important;
      }
      
      /* Element button hover effects */
      .element-btn:hover {
        background-color: #f0f8ff !important;
        border-color: #2D6356 !important;
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(45, 99, 86, 0.2);
      }
      
      /* Menu animation */
      #elements-menu {
        animation: fadeInUp 0.2s ease-in-out;
      }
      
      @keyframes fadeInUp {
        from { 
          opacity: 0; 
          transform: translateX(-50%) translateY(10px); 
        }
        to { 
          opacity: 1; 
          transform: translateX(-50%) translateY(0); 
        }
      }
      
      /* Backdrop overlay */
      .menu-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.1);
        z-index: 999;
        display: none;
      }
      
      /* Outcome Measure Modal Styles */
      #outcomeMeasureModal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1050;
        background-color: white;
        padding: 24px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        display: none;
        max-height: 80vh;
        overflow-y: auto;
      }

      #outcomeMeasureModal.show {
        display: block;
        animation: modalSlideIn 0.3s ease-out;
      }
      
      @keyframes modalSlideIn {
        from { 
          opacity: 0; 
          transform: translate(-50%, -60%);
        }
        to { 
          opacity: 1; 
          transform: translate(-50%, -50%);
        }
      }

      /* Modal backdrop */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        display: none;
      }
      
      /* Step indicator */
      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 24px;
        gap: 12px;
      }
      
      .step {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        background: #ccc;
        transition: all 0.3s ease;
      }
      
      .step.active {
        background: #2D6356;
        transform: scale(1.1);
      }
      
      .step.completed {
        background: #28a745;
      }
      
      /* Step content */
      .step-content {
        display: none;
        min-height: 200px;
      }
      
      .step-content.active {
        display: block;
        animation: stepFadeIn 0.3s ease-in;
      }
      
      @keyframes stepFadeIn {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
      }
      
      /* Domain grid */
      .domain-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 16px;
      }
      
      .domain-card {
        padding: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
      }
      
      .domain-card:hover {
        border-color: #2D6356;
        background: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(45, 99, 86, 0.2);
      }
      
      .domain-card.selected {
        border-color: #2D6356;
        background: #e8f5e8;
        font-weight: bold;
      }
      
      /* Measure list */
      .measure-list {
        margin-top: 16px;
        max-height: 300px;
        overflow-y: auto;
      }
      
      .measure-item {
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
      }
      
      .measure-item:hover {
        border-color: #2D6356;
        background: #f8f9fa;
      }
      
      .measure-item.selected {
        border-color: #2D6356;
        background: #e8f5e8;
        font-weight: bold;
      }
      
      .measure-description {
        font-size: 0.9em;
        color: #666;
        margin-top: 4px;
      }
      
      /* Form styles */
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 6px;
        color: #333;
      }
      
      .form-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      
      .form-input:focus {
        outline: none;
        border-color: #2D6356;
        box-shadow: 0 0 0 2px rgba(45, 99, 86, 0.2);
      }
      
      /* Subscore table */
      .subscores-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }
      
      .subscores-table th,
      .subscores-table td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }
      
      .subscores-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #555;
      }
      
      .subscores-table input {
        width: 80px;
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 3px;
        text-align: center;
      }
      
      /* Navigation buttons */
      .modal-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid #e0e0e0;
      }
      
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
      }
      
      .btn-primary {
        background: #2D6356;
        color: white;
      }
      
      .btn-primary:hover {
        background: #24523b;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(45, 99, 86, 0.3);
      }
      
      .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      .btn-secondary {
        background: #6c757d;
        color: white;
      }
      
      .btn-secondary:hover {
        background: #5a6268;
      }
      
      .btn-outline {
        background: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
      }
      
      .btn-outline:hover {
        background: #6c757d;
        color: white;
      }
      
      /* Outcome Measures Display Section */
      .outcome-measures-section {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
      }
      
      .outcome-measure-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s ease;
      }
      
      .outcome-measure-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }
      
      .measure-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }
      
      .measure-info h4 {
        margin: 0 0 4px 0;
        color: #2D6356;
        font-size: 1.1em;
      }
      
      .measure-meta {
        display: flex;
        gap: 16px;
        font-size: 0.85em;
        color: #666;
        margin-bottom: 8px;
      }
      
      .measure-meta span {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      
      .score-display {
        font-size: 1.2em;
        font-weight: bold;
        color: #2D6356;
        text-align: right;
      }
      
      .subscores-summary {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e0e0e0;
      }
      
      .subscore-item {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 0.9em;
      }
      
      .subscore-name {
        color: #555;
      }
      
      .subscore-score {
        font-weight: 500;
        color: #333;
      }
      
      .measure-actions {
        display: flex;
        gap: 8px;
      }
      
      .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      
      .action-btn-edit {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
      }
      
      .action-btn-edit:hover {
        background: #bbdefb;
        transform: translateY(-1px);
      }
      
      .action-btn-delete {
        background: #ffebee;
        color: #d32f2f;
        border: 1px solid #ffcdd2;
      }
      
      .action-btn-delete:hover {
        background: #ffcdd2;
        transform: translateY(-1px);
      }
      
      .measure-comments {
        margin-top: 8px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 0.9em;
        color: #666;
        font-style: italic;
      }
      
      .no-measures-message {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 2rem;
      }
    </style>
    <!-- Modal backdrop -->
    <div id="modalBackdrop" class="modal-backdrop" onclick="closeOutcomeMeasureModal()"></div>
    
    <!-- Three-step Outcome Measure Modal -->
    <div id="outcomeMeasureModal" class="modal">
      <!-- Step indicator -->
      <div class="step-indicator">
        <div class="step active" id="step1">1</div>
        <div class="step" id="step2">2</div>
        <div class="step" id="step3">3</div>
      </div>
      
      <h3 id="modalTitle">Select Domain</h3>
      
      <!-- Step 1: Domain Selection -->
      <div id="step1Content" class="step-content active">
        <p>Choose the domain/category for your outcome measure:</p>
        <div id="domainGrid" class="domain-grid">
          <!-- Domains will be loaded here -->
        </div>
      </div>
      
      <!-- Step 2: Measure Selection -->
      <div id="step2Content" class="step-content">
        <p>Select the specific outcome measure:</p>
        <div id="measureList" class="measure-list">
          <!-- Measures will be loaded here -->
        </div>
      </div>
      
      <!-- Step 3: Score Input -->
      <div id="step3Content" class="step-content">
        <div id="measureDetails">
          <!-- Measure details and inputs will be loaded here -->
        </div>
        
        <div class="form-group">
          <label class="form-label" for="commentsInput">Comments (optional)</label>
          <textarea id="commentsInput" class="form-input" rows="3" placeholder="Add any additional notes..."></textarea>
        </div>
      </div>
      
      <!-- Navigation -->
      <div class="modal-nav">
        <div>
          <button type="button" id="prevBtn" class="btn btn-outline" onclick="previousStep()" style="display: none;">Previous</button>
        </div>
        <div>
          <button type="button" id="nextBtn" class="btn btn-primary" onclick="nextStep()">Next</button>
          <button type="button" id="saveBtn" class="btn btn-primary" onclick="saveOutcomeMeasure()" style="display: none;">Add Measure</button>
          <button type="button" class="btn btn-secondary" onclick="closeOutcomeMeasureModal()" style="margin-left: 8px;">Cancel</button>
        </div>
      </div>
    </div>
  <script>
    function showToast(message, bgColor = "#2D6356") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.textContent = message;
      toast.style.backgroundColor = bgColor;
      toast.style.color = "white";
      toast.style.padding = "0.75rem 1.25rem";
      toast.style.borderRadius = "8px";
      toast.style.fontSize = "0.9rem";
      toast.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
      toast.style.minWidth = "220px";
      toast.style.textAlign = "center";
      toast.style.opacity = "0.95";

      container.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
  </script>
  <script>
    // ===== THREE-STEP OUTCOME MEASURE MODAL =====
    
    let currentStep = 1;
    let selectedDomain = null;
    let selectedMeasure = null;
    let selectedMeasureData = null;
    let editingMeasureId = null;  // For edit mode
    
    // Open modal and load domains
    async function openOutcomeMeasureModal(measureId = null) {
      try {
        editingMeasureId = measureId;
        
        // Show modal and backdrop
        document.getElementById("modalBackdrop").style.display = "block";
        document.getElementById("outcomeMeasureModal").classList.add("show");
        
        if (editingMeasureId) {
          // Edit mode - load existing measure data
          await loadExistingMeasure(editingMeasureId);
        } else {
          // New mode - reset to step 1
          currentStep = 1;
          selectedDomain = null;
          selectedMeasure = null;
          selectedMeasureData = null;
          updateStepUI();
        }
        
        // Load domains for step 1
        await loadDomains();
        
      } catch (error) {
        console.error("Failed to open outcome measure modal:", error);
        showToast("Failed to open modal", "#dc3545");
      }
    }
    
    // Load existing measure for editing
    async function loadExistingMeasure(measureId) {
      try {
        const response = await fetch(`/api/outcome-measures/${measureId}`);
        const measure = await response.json();
        
        selectedDomain = measure.category;
        selectedMeasure = measure.outcome_measure_type_id;
        selectedMeasureData = measure;
        
        // Pre-fill comments
        document.getElementById("commentsInput").value = measure.comments || "";
        
        // Skip to step 3 for editing
        currentStep = 3;
        updateStepUI();
        
        // Load the measure details
        await loadMeasureDetails(measure.outcome_measure_type_id, measure);
        
      } catch (error) {
        console.error("Failed to load existing measure:", error);
        showToast("Failed to load measure data", "#dc3545");
      }
    }
    
    // Close modal
    function closeOutcomeMeasureModal() {
      document.getElementById("modalBackdrop").style.display = "none";
      document.getElementById("outcomeMeasureModal").classList.remove("show");
      
      // Reset state
      currentStep = 1;
      selectedDomain = null;
      selectedMeasure = null;
      selectedMeasureData = null;
      editingMeasureId = null;
      
      // Clear form
      document.getElementById("commentsInput").value = "";
      updateStepUI();
    }
    
    // Load available domains/categories
    async function loadDomains() {
      try {
        const response = await fetch("/api/outcome-measure-types/categories");
        const domains = await response.json();
        
        const domainGrid = document.getElementById("domainGrid");
        domainGrid.innerHTML = "";
        
        domains.forEach(domain => {
          const domainCard = document.createElement("div");
          domainCard.className = "domain-card";
          domainCard.textContent = domain;
          domainCard.onclick = () => selectDomain(domain, domainCard);
          
          if (selectedDomain === domain) {
            domainCard.classList.add("selected");
          }
          
          domainGrid.appendChild(domainCard);
        });
        
      } catch (error) {
        console.error("Failed to load domains:", error);
        showToast("Failed to load domains", "#dc3545");
      }
    }
    
    // Select a domain
    function selectDomain(domain, cardElement) {
      // Remove previous selection
      document.querySelectorAll(".domain-card.selected").forEach(card => {
        card.classList.remove("selected");
      });
      
      // Mark new selection
      cardElement.classList.add("selected");
      selectedDomain = domain;
      
      // Enable next button
      document.getElementById("nextBtn").disabled = false;
    }
    
    // Load measures for selected domain
    async function loadMeasures() {
      try {
        const response = await fetch(`/api/outcome-measure-types/by-category/${encodeURIComponent(selectedDomain)}`);
        const measures = await response.json();
        
        const measureList = document.getElementById("measureList");
        measureList.innerHTML = "";
        
        // Get detailed measure information
        for (const measure of measures) {
          const detailResponse = await fetch(`/api/outcome-measure-types/${measure.id}/subscores`);
          const subscores = await detailResponse.json();
          
          const measureItem = document.createElement("div");
          measureItem.className = "measure-item";
          measureItem.onclick = () => selectMeasure(measure, measureItem);
          
          if (selectedMeasure === measure.id) {
            measureItem.classList.add("selected");
          }
          
          measureItem.innerHTML = `
            <strong>${measure.name}</strong>
            <div class="measure-description">
              ${subscores.length > 0 ? `Has ${subscores.length} subscores` : 'Single score measure'}
            </div>
          `;
          
          measureList.appendChild(measureItem);
        }
        
      } catch (error) {
        console.error("Failed to load measures:", error);
        showToast("Failed to load measures", "#dc3545");
      }
    }
    
    // Select a measure
    function selectMeasure(measure, itemElement) {
      // Remove previous selection
      document.querySelectorAll(".measure-item.selected").forEach(item => {
        item.classList.remove("selected");
      });
      
      // Mark new selection
      itemElement.classList.add("selected");
      selectedMeasure = measure.id;
      selectedMeasureData = measure;
      
      // Enable next button
      document.getElementById("nextBtn").disabled = false;
    }
    
    // Load measure details and input form
    async function loadMeasureDetails(measureTypeId, existingData = null) {
      try {
        const [typeResponse, subscoresResponse] = await Promise.all([
          fetch(`/api/outcome-measure-types`),
          fetch(`/api/outcome-measure-types/${measureTypeId}/subscores`)
        ]);
        
        if (!typeResponse.ok || !subscoresResponse.ok) {
          throw new Error("Failed to load measure type or subscores data");
        }
        
        const allTypes = await typeResponse.json();
        const subscores = await subscoresResponse.json();
        
        console.log("All types:", allTypes, "Looking for ID:", measureTypeId);
        const measureType = allTypes.find(t => t.id === parseInt(measureTypeId));
        
        if (!measureType) {
          throw new Error(`Measure type not found for ID: ${measureTypeId}`);
        }
        
        const measureDetails = document.getElementById("measureDetails");
        
        let html = `
          <div class="form-group">
            <h4>${measureType.name}</h4>
            <p style="color: #666; font-size: 0.9em;">${measureType.description || ''}</p>
          </div>
        `;
        
        if (subscores.length > 0) {
          // Multiple subscores
          html += `
            <div class="form-group">
              <label class="form-label">Subscores</label>
              <table class="subscores-table">
                <thead>
                  <tr>
                    <th>Component</th>
                    <th>Max Score</th>
                    <th>Your Score</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          subscores.forEach((subscore, index) => {
            const existingScore = existingData?.subscores?.find(s => 
              s.subcategory_name === subscore.subcategory_name
            )?.score || '';
            
            html += `
              <tr>
                <td>${subscore.subcategory_name}</td>
                <td>${subscore.max_score || 'N/A'}</td>
                <td>
                  <input 
                    type="number" 
                    class="subscore-input" 
                    data-subscore-id="${subscore.id}"
                    data-subscore-name="${subscore.subcategory_name}"
                    data-max-score="${subscore.max_score || ''}"
                    min="0" 
                    ${subscore.max_score ? `max="${subscore.max_score}"` : ''}
                    value="${existingScore}"
                    onchange="calculateTotalScore()"
                  />
                </td>
              </tr>
            `;
          });
          
          html += `
                </tbody>
              </table>
              <div id="totalScoreDisplay" style="margin-top: 12px; font-weight: bold;"></div>
            </div>
          `;
        } else {
          // Single score measure
          const existingScore = existingData?.score || '';
          html += `
            <div class="form-group">
              <label class="form-label" for="totalScoreInput">
                Total Score ${measureType.max_score ? `(Max: ${measureType.max_score})` : ''}
              </label>
              <input 
                type="number" 
                id="totalScoreInput" 
                class="form-input" 
                min="0" 
                ${measureType.max_score ? `max="${measureType.max_score}"` : ''}
                value="${existingScore}"
                placeholder="Enter score..."
              />
            </div>
          `;
        }
        
        measureDetails.innerHTML = html;
        
        if (subscores.length > 0) {
          calculateTotalScore();
        }
        
      } catch (error) {
        console.error("Failed to load measure details:", error);
        showToast("Failed to load measure details", "#dc3545");
      }
    }
    
    // Calculate total score from subscores
    function calculateTotalScore() {
      const subscoreInputs = document.querySelectorAll(".subscore-input");
      let total = 0;
      let hasValues = false;
      
      subscoreInputs.forEach(input => {
        const value = parseFloat(input.value);
        if (!isNaN(value)) {
          total += value;
          hasValues = true;
        }
      });
      
      const display = document.getElementById("totalScoreDisplay");
      if (display) {
        if (hasValues) {
          display.innerHTML = `<strong>Total Score: ${total}</strong>`;
        } else {
          display.innerHTML = "";
        }
      }
    }
    
    // Navigation functions
    function nextStep() {
      if (currentStep === 1 && !selectedDomain) {
        showToast("Please select a domain", "#dc3545");
        return;
      }
      
      if (currentStep === 2 && !selectedMeasure) {
        showToast("Please select a measure", "#dc3545");
        return;
      }
      
      if (currentStep < 3) {
        currentStep++;
        updateStepUI();
        
        if (currentStep === 2) {
          loadMeasures();
        } else if (currentStep === 3) {
          loadMeasureDetails(selectedMeasure);
        }
      }
    }
    
    function previousStep() {
      if (currentStep > 1) {
        currentStep--;
        updateStepUI();
      }
    }
    
    // Update UI based on current step
    function updateStepUI() {
      // Update step indicators
      for (let i = 1; i <= 3; i++) {
        const step = document.getElementById(`step${i}`);
        const content = document.getElementById(`step${i}Content`);
        
        if (i < currentStep) {
          step.className = "step completed";
        } else if (i === currentStep) {
          step.className = "step active";
        } else {
          step.className = "step";
        }
        
        content.classList.toggle("active", i === currentStep);
      }
      
      // Update titles
      const titles = ["Select Domain", "Select Measure", editingMeasureId ? "Edit Scores" : "Enter Scores"];
      document.getElementById("modalTitle").textContent = titles[currentStep - 1];
      
      // Update navigation buttons
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const saveBtn = document.getElementById("saveBtn");
      
      prevBtn.style.display = currentStep === 1 ? "none" : "block";
      nextBtn.style.display = currentStep === 3 ? "none" : "block";
      saveBtn.style.display = currentStep === 3 ? "block" : "none";
      
      // Update button text
      if (editingMeasureId && currentStep === 3) {
        saveBtn.textContent = "Update Measure";
      } else {
        saveBtn.textContent = "Add Measure";
      }
      
      // Enable/disable next button based on selection
      if (currentStep === 1) {
        nextBtn.disabled = !selectedDomain;
      } else if (currentStep === 2) {
        nextBtn.disabled = !selectedMeasure;
      }
    }
    
    // Save outcome measure
    async function saveOutcomeMeasure() {
      try {
        const appointmentId = window.appt?.id;
        const patientId = window.appt?.patient_id;
        const therapist = window.therapistName || "";
        
        console.log("Save data:", { appointmentId, patientId, therapist, selectedMeasure });
        
        if (!appointmentId || !patientId) {
          showToast("Missing appointment or patient information", "#dc3545");
          return;
        }
        
        if (!selectedMeasure) {
          showToast("No measure selected", "#dc3545");
          return;
        }
        
        // Collect score data
        let totalScore = null;
        const subscores = [];
        
        const subscoreInputs = document.querySelectorAll(".subscore-input");
        if (subscoreInputs.length > 0) {
          // Has subscores
          subscoreInputs.forEach(input => {
            const score = input.value ? parseFloat(input.value) : null;
            const maxScore = input.dataset.maxScore ? parseInt(input.dataset.maxScore) : null;
            
            subscores.push({
              subcategory_name: input.dataset.subscoreName,
              score: score,
              max_score: maxScore,
              comments: ""
            });
            
            if (score !== null) {
              totalScore = (totalScore || 0) + score;
            }
          });
        } else {
          // Single score
          const totalInput = document.getElementById("totalScoreInput");
          if (totalInput && totalInput.value) {
            totalScore = parseFloat(totalInput.value);
          }
        }
        
        const comments = document.getElementById("commentsInput").value;
        
        // Prepare payload - convert patient_id to string to match validation
        const payload = {
          patient_id: String(patientId),
          therapist: therapist || "",
          appointment_id: appointmentId,
          date: new Date().toISOString().split("T")[0],
          outcome_measure_type_id: selectedMeasure,
          score: totalScore,
          comments: comments || ""
        };
        
        console.log("Payload:", payload);
        
        let measureId;
        
        if (editingMeasureId) {
          // Update existing measure
          await fetch(`/api/outcome-measures/${editingMeasureId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          measureId = editingMeasureId;
        } else {
          // Create new measure
          const response = await fetch("/api/outcome-measures", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error("Create measure failed:", response.status, errorText);
            throw new Error(`Failed to create measure: ${response.status} ${errorText}`);
          }
          
          const result = await response.json();
          measureId = result.id;
        }
        
        // Save subscores if any
        if (subscores.length > 0 && subscores.some(s => s.score !== null)) {
          console.log("Saving subscores for measureId:", measureId, subscores);
          if (!measureId || measureId === "undefined") {
            console.error("Invalid measureId for subscores:", measureId);
            throw new Error("Invalid measure ID for subscores");
          }
          
          const subscoreResponse = await fetch(`/api/outcome-measures/${measureId}/subscores`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(subscores)
          });
          
          if (!subscoreResponse.ok) {
            const errorText = await subscoreResponse.text();
            console.error("Subscore save failed:", subscoreResponse.status, errorText);
            throw new Error(`Failed to save subscores: ${subscoreResponse.status} ${errorText}`);
          }
        }
        
        closeOutcomeMeasureModal();
        showToast(editingMeasureId ? "Outcome measure updated!" : "Outcome measure added!", "#2D6356");
        
        // Refresh the measures display
        
      } catch (error) {
        console.error("Failed to save outcome measure:", error);
        showToast("Failed to save measure", "#dc3545");
      }
    }
    
    
    
    // Create HTML card for a measure
    function createMeasureCard(measure) {
      const card = document.createElement("div");
      card.className = "outcome-measure-card";
      card.dataset.measureId = measure.id;
      
      const timestamp = new Date(measure.created_at || measure.date).toLocaleString();
      const domain = measure.category || 'Unknown';
      
      let scoreDisplay = '';
      if (measure.score !== null && measure.score !== undefined) {
        scoreDisplay = `<div class="score-display">${measure.score}`;
        if (measure.max_score) {
          scoreDisplay += ` / ${measure.max_score}`;
        }
        scoreDisplay += `</div>`;
      }
      
      let subscoresHtml = '';
      if (measure.subscores && measure.subscores.length > 0) {
        subscoresHtml = `
          <div class="subscores-summary">
            <strong>Components:</strong>
            ${measure.subscores.map(sub => `
              <div class="subscore-item">
                <span class="subscore-name">${sub.subcategory_name}</span>
                <span class="subscore-score">${sub.score || 'N/A'}${sub.max_score ? `/${sub.max_score}` : ''}</span>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      let commentsHtml = '';
      if (measure.comments && measure.comments.trim()) {
        commentsHtml = `<div class="measure-comments">"${measure.comments}"</div>`;
      }
      
      card.innerHTML = `
        <div class="measure-header">
          <div class="measure-info">
            <h4>${measure.type_name || 'Unknown Measure'}</h4>
            <div class="measure-meta">
              <span>
                <span class="material-icons" style="font-size: 14px;">category</span>
                ${domain}
              </span>
              <span>
                <span class="material-icons" style="font-size: 14px;">schedule</span>
                ${timestamp}
              </span>
            </div>
          </div>
          ${scoreDisplay}
        </div>
        
        ${subscoresHtml}
        ${commentsHtml}
        
        <div class="measure-actions">
          <button class="action-btn action-btn-edit" onclick="editOutcomeMeasure(${measure.id})">
            <span class="material-icons" style="font-size: 14px;">edit</span>
            Edit
          </button>
          <button class="action-btn action-btn-delete" onclick="confirmDeleteOutcomeMeasure(${measure.id}, '${measure.type_name || 'this measure'}')">
            <span class="material-icons" style="font-size: 14px;">delete</span>
            Remove
          </button>
        </div>
      `;
      
      return card;
    }
    
    // Edit existing outcome measure
    function editOutcomeMeasure(measureId) {
      openOutcomeMeasureModal(measureId);
    }
    
    // Confirm and delete outcome measure
    function confirmDeleteOutcomeMeasure(measureId, measureName) {
      if (confirm(`Are you sure you want to remove "${measureName}"?\n\nThis action cannot be undone.`)) {
        deleteOutcomeMeasure(measureId);
      }
    }
    
    // Delete outcome measure
    async function deleteOutcomeMeasure(measureId) {
      try {
        const response = await fetch(`/api/outcome-measures/${measureId}`, {
          method: "DELETE"
        });
        
        if (!response.ok) {
          throw new Error("Failed to delete measure");
        }
        
        showToast("Outcome measure removed", "#2D6356");
        
      } catch (error) {
        console.error("Failed to delete outcome measure:", error);
        showToast("Failed to remove measure", "#dc3545");
      }
    }
    
    // Load measures when page loads
    document.addEventListener("DOMContentLoaded", function() {
      // Wait a bit for appointment data to load
    });
  </script>
    </body>
    </html>
    <script>
      function showBillingSection() {
        document.getElementById("billing-section").style.display = "block";
        document.getElementById("show-billing-button").style.display = "none";
      }

// Treatment Note Elements Functions
function toggleElementsMenu() {
  const menu = document.getElementById('elements-menu');
  const button = document.getElementById('add-elements-btn');
  const backdrop = document.getElementById('menu-backdrop');
  
  if (menu.style.display === 'none') {
    menu.style.display = 'block';
    backdrop.style.display = 'block';
    button.textContent = '✕';
    button.style.transform = 'rotate(45deg)';
  } else {
    closeElementsMenu();
  }
}

function closeElementsMenu() {
  const menu = document.getElementById('elements-menu');
  const button = document.getElementById('add-elements-btn');
  const backdrop = document.getElementById('menu-backdrop');
  
  menu.style.display = 'none';
  backdrop.style.display = 'none';
  button.textContent = '+';
  button.style.transform = 'rotate(0deg)';
}

// Placeholder functions for each element type (to be implemented)
function addOutcomeMeasures() {
  console.log('Adding Outcome Measures...');
  closeElementsMenu();
  
  // Show the outcome measures section if hidden
  const outcomesSection = document.getElementById('outcome-measures-section');
  if (outcomesSection) {
    outcomesSection.style.display = 'block';
  }
  
  // Get the current treatment note ID from the booking ID
  const params = new URLSearchParams(window.location.search);
  const bookingId = params.get("booking_id");
  
  if (bookingId && outcomeMgr) {
    outcomeMgr.openOutcomeModal(bookingId);
  } else {
    showToast('Unable to add outcome measures. Please ensure the treatment note is loaded.', '#dc3545');
  }
}

// Load existing outcome measures for a treatment note
async function loadExistingOutcomeMeasures(treatmentNoteId) {
  try {
    const response = await fetch(`/api/treatment-notes/${treatmentNoteId}/outcome-entries`);
    if (response.ok) {
      const data = await response.json();
      if (data.entries && data.entries.length > 0) {
        // Show the outcome measures section
        const outcomesSection = document.getElementById('outcome-measures-section');
        if (outcomesSection) {
          outcomesSection.style.display = 'block';
        }
        
        // Populate the outcomes list
        if (outcomeMgr) {
          outcomeMgr.renderOutcomesList(data.entries);
        }
      }
    }
  } catch (error) {
    console.warn('Could not load existing outcome measures:', error);
  }
}

function addReminders() {
  console.log('Adding Reminders...');
  closeElementsMenu();
  // TODO: Implement reminders functionality
  showToast('Reminders feature coming soon!', '#f39c12');
}

function addGoals() {
  console.log('Adding Goals...');
  closeElementsMenu();
  // TODO: Implement goals functionality
  showToast('Goals feature coming soon!', '#f39c12');
}

function addEquipment() {
  console.log('Adding Equipment...');
  closeElementsMenu();
  // TODO: Implement equipment functionality
  showToast('Equipment feature coming soon!', '#f39c12');
}

function addPatientMessage() {
  console.log('Adding Patient Message...');
  closeElementsMenu();
  // TODO: Implement patient message functionality
  showToast('Patient Message feature coming soon!', '#f39c12');
}

function addTeamAlert() {
  console.log('Adding Team Alert...');
  closeElementsMenu();
  // TODO: Implement team alert functionality
  showToast('Team Alert feature coming soon!', '#f39c12');
}

function addUploads() {
  console.log('Adding Uploads...');
  closeElementsMenu();
  // TODO: Implement uploads functionality (pictures, voice notes, files)
  showToast('Uploads feature coming soon!', '#f39c12');
}
    </script>