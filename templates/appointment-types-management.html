<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Appointment Types Management</title>
    <link rel="stylesheet" href="/static/calendar.css">
    <link rel="stylesheet" href="/static/nav.css">
    <link rel="stylesheet" href="/static/css/appointment-type-modal.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .management-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #2D6356 0%, #1d4a3a 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(45, 99, 86, 0.2);
            color: white;
        }
        
        .management-header h1 {
            color: white;
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .management-header h1::before {
            content: 'üóÇÔ∏è';
            font-size: 2rem;
        }
        
        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .appointment-types-grid {
            display: grid;
            gap: 1.5rem;
        }
        
        .category-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .category-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .category-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .category-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
        }
        
        .appointment-type-list {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        
        .appointment-type-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .appointment-type-item:hover {
            background: #f9fafb;
        }
        
        .appointment-type-item:last-child {
            border-bottom: none;
        }
        
        .type-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }
        
        .type-color-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .type-name {
            font-weight: 500;
            color: #1f2937;
            flex: 1;
        }
        
        .type-details {
            display: flex;
            gap: 1rem;
            align-items: center;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .type-duration {
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        
        .type-billing {
            background: #f3f1ff;
            color: #8b5cf6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .type-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .type-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            background: transparent;
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }
        
        .btn-edit {
            color: #2563eb;
        }
        
        .btn-delete {
            color: #dc2626;
        }
        
        .btn-toggle {
            color: #6b7280;
        }
        
        .empty-state {
            padding: 3rem;
            text-align: center;
            color: #6b7280;
        }
        
        .add-type-row {
            padding: 1rem 1.5rem;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .btn-add-type {
            background: transparent;
            color: #2D6356;
            border: 1px solid #2D6356;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-add-type:hover {
            background: #2D6356;
            color: white;
        }
        
        /* Quick Add Styles */
        .add-type-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .btn-add-type-quick {
            background: #16a34a;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .btn-add-type-quick:hover {
            background: #15803d;
        }
        
        .btn-add-type {
            background: transparent;
            color: #2D6356;
            border: 1px solid #2D6356;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .quick-add-container {
            margin-bottom: 1rem;
        }
        
        .quick-add-form {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .quick-add-input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem;
            border: 2px solid #2D6356;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .quick-add-input:focus {
            outline: none;
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }
        
        .btn-quick-save {
            background: #16a34a;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-quick-save:hover {
            background: #15803d;
        }
        
        .btn-quick-cancel {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-quick-cancel:hover {
            background: #4b5563;
        }
        
        /* Category Management Styles */
        .category-header {
            position: relative;
            cursor: pointer;
        }
        
        .category-expand-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s ease;
            padding: 0.25rem;
            border-radius: 4px;
            margin-right: 0.5rem;
        }
        
        .category-expand-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #374151;
        }
        
        .category-expand-btn.expanded {
            transform: rotate(90deg);
        }
        
        .appointment-type-list.collapsed {
            display: none;
        }
        
        .add-type-row.collapsed {
            display: none;
        }
        
        .category-inline-edit {
            display: none;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }
        
        .category-name-input {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid #2D6356;
            border-radius: 4px;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .category-color-input {
            width: 40px;
            height: 40px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .category-edit-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-category-save, .btn-category-cancel {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        
        .btn-category-save {
            background: #16a34a;
            color: white;
        }
        
        .btn-category-save:hover {
            background: #15803d;
        }
        
        .btn-category-cancel {
            background: #6b7280;
            color: white;
        }
        
        .btn-category-cancel:hover {
            background: #4b5563;
        }
        
        .category-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-icon.btn-reorder {
            color: #9ca3af;
            cursor: grab;
        }
        
        .btn-icon.btn-reorder:active {
            cursor: grabbing;
        }
        
        .btn-icon.btn-reorder:hover {
            color: #6b7280;
        }
        
        /* Drag and Drop Styles */
        .category-section.dragging {
            opacity: 0.5;
        }
        
        .category-section.drag-over {
            border-top: 3px solid #2D6356;
        }
        
        /* Visual Enhancement Styles */
        .category-count-badge {
            background: #e5e7eb;
            color: #374151;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
            min-width: 24px;
            text-align: center;
        }
        
        .category-count-badge.has-types {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .category-section {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .category-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .appointment-type-item {
            transition: background-color 0.2s ease;
        }
        
        .appointment-type-item:hover {
            background: #f8fafc;
            border-left: 4px solid #2D6356;
            padding-left: calc(1.5rem - 4px);
        }
        
        .type-color-indicator {
            transition: all 0.2s ease;
        }
        
        .appointment-type-item:hover .type-color-indicator {
            transform: scale(1.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .category-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transition: background 0.2s ease;
        }
        
        .category-section:hover .category-header {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        
        .btn-icon {
            transition: all 0.2s ease;
        }
        
        .btn-icon:hover {
            transform: scale(1.1);
        }
        
        .status-active {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 1px solid #10b981;
        }
        
        .status-inactive {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 1px solid #ef4444;
        }
        
        .type-billing {
            background: linear-gradient(135deg, #f3f1ff 0%, #ede9fe 100%);
            border: 1px solid #8b5cf6;
        }
        
        .type-duration {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border: 1px solid #6b7280;
        }
        
        .empty-state {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            margin: 1rem;
            color: #9ca3af;
            font-style: italic;
        }
        
        .add-type-buttons {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-top: 1px solid #e5e7eb;
            transition: background 0.2s ease;
        }
        
        .add-type-buttons:hover {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #1f2937;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2D6356;
            box-shadow: 0 0 0 3px rgba(45, 99, 86, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            border: 2px solid #d1d5db;
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .btn-secondary {
            background: white;
            color: #6b7280;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .btn-secondary:hover {
            background: #f9fafb;
        }
        
        /* Override appointment-type-modal.css that interferes with main page */
        .management-container .appointment-type-list {
            max-height: none !important;
            height: auto !important;
            overflow: visible !important;
        }
        
        /* Modal CSS - Fix for missing modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.19);
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 25px;
        }
        
        .modal-header {
            flex-shrink: 0;
            padding: 20px 25px 15px 25px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .modal-footer {
            flex-shrink: 0;
            padding: 15px 25px 20px 25px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-header {
            padding: 20px 25px 15px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #2D6356;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 20px 25px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 15px 25px 20px 25px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-shrink: 0;
        }
        
        /* Override button styles for modal - fix invisible save button */
        .modal-footer .btn-primary {
            background: #2D6356 !important;
            color: white !important;
            border: 1px solid #2D6356 !important;
            backdrop-filter: none !important;
            padding: 8px 16px !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
        }
        
        .modal-footer .btn-primary:hover {
            background: #1d4a3a !important;
            border-color: #1d4a3a !important;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .modal-footer .btn-secondary {
            padding: 8px 16px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
        }
    </style>
</head>
<body>
    <script src="/static/js/nav-bar.js"></script>
    <div id="top-nav"></div>
    
    <div class="management-container">
        <div class="management-header">
            <h1>Appointment Types Management</h1>
            <button class="btn-primary" onclick="openCreateModal()">
                <span class="material-icons">add</span>
                Add Appointment Type
            </button>
        </div>
        
        <div class="appointment-types-grid" id="appointment-types-container">
            <!-- Categories and appointment types will be loaded here -->
            <div class="loading-state" style="text-align: center; padding: 3rem;">
                <div class="spinner"></div>
                <p>Loading appointment types...</p>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="appointment-type-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Create Appointment Type</h2>
            </div>
            <div class="modal-body">
                <form id="appointment-type-form">
                    <input type="hidden" id="type-id" />
                    
                    <div class="form-group">
                        <label for="type-name">Name *</label>
                        <input type="text" id="type-name" required placeholder="e.g., New Assessment, Follow-up">
                    </div>
                    
                    <div class="form-group">
                        <label for="type-category">Category *</label>
                        <select id="type-category" required>
                            <option value="">Select a category</option>
                            <option value="new">+ Create New Category</option>
                        </select>
                        <input type="text" id="new-category-name" style="display: none; margin-top: 0.5rem;" 
                               placeholder="Enter new category name">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="type-duration">Duration (minutes) *</label>
                            <input type="number" id="type-duration" required min="5" max="480" step="5" value="30">
                        </div>
                        
                        <div class="form-group">
                            <label for="type-color">Color *</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="type-color" value="#2D6356">
                                <div class="color-preview" id="color-preview"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Default Billing Codes</label>
                        <div class="billing-codes-section">
                            <table id="type-billing-table" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Code</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Description</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Qty</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Modifier</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Rate</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Total</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 40px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="type-billing-table-body">
                                    <!-- Initial row will be added by JavaScript -->
                                </tbody>
                            </table>
                            <button type="button" id="add-billing-code-btn" onclick="addTypeBillingRow()" 
                                    style="margin-top: 10px; padding: 5px 10px; background: #2D6356; color: white; border: none; border-radius: 4px;">
                                + Add Billing Code
                            </button>
                            <div id="type-billing-total" style="margin-top: 10px; font-weight: bold; text-align: right; color: #2D6356;">
                                Total: R0.00
                            </div>
                            <datalist id="type-billing-codes-datalist"></datalist>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="type-default-notes">Default Notes Template</label>
                        <textarea id="type-default-notes" rows="3" 
                                  placeholder="Template text that will be pre-filled in booking notes"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="type-description">Description</label>
                        <textarea id="type-description" rows="2" 
                                  placeholder="Brief description of this appointment type"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="type-sort-order">Sort Order</label>
                            <input type="number" id="type-sort-order" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="type-status">Status</label>
                            <select id="type-status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="type-requires-auth"> 
                            Requires Authorization
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="type-billable" checked> 
                            Billable Appointment
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="saveAppointmentType()">Save</button>
            </div>
        </div>
    </div>

    <script>
        let currentPracticeId = 1; // This should come from session/auth
        let appointmentTypes = [];
        let editingTypeId = null;

        // Load appointment types on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadAppointmentTypes();
            loadBillingCodes();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Category dropdown change handler
            document.getElementById('type-category').addEventListener('change', (e) => {
                const newCategoryInput = document.getElementById('new-category-name');
                if (e.target.value === 'new') {
                    newCategoryInput.style.display = 'block';
                    newCategoryInput.required = true;
                } else {
                    newCategoryInput.style.display = 'none';
                    newCategoryInput.required = false;
                }
            });

            // Color picker sync
            document.getElementById('type-color').addEventListener('input', (e) => {
                document.getElementById('color-preview').style.backgroundColor = e.target.value;
            });

            // Modal close on overlay click
            document.getElementById('appointment-type-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeModal();
                }
            });

            // Billing codes functionality is handled by the table functions
        }

        // Store billing codes and modifiers globally
        let allBillingCodes = [];
        let allBillingModifiers = [];

        // Load billing codes from the system
        async function loadBillingCodes() {
            try {
                console.log('üîÑ Loading billing codes...');
                const response = await fetch('/api/billing-codes');
                if (!response.ok) throw new Error('Failed to load billing codes');
                
                allBillingCodes = await response.json();
                console.log('‚úÖ Loaded billing codes:', allBillingCodes.length);
                
                // Populate datalist for billing codes
                const datalist = document.getElementById('type-billing-codes-datalist');
                datalist.innerHTML = '';
                allBillingCodes.forEach(code => {
                    const option = document.createElement('option');
                    option.value = code.code;
                    option.textContent = `${code.code} - ${code.description}`;
                    datalist.appendChild(option);
                });
                
                // Load billing modifiers
                await loadBillingModifiers();
                
                // Add initial billing row
                addTypeBillingRow();
                
                console.log('‚úÖ Billing codes system initialized');
            } catch (error) {
                console.error('‚ùå Error loading billing codes:', error);
                showError('Failed to load billing codes');
            }
        }

        // Load billing modifiers
        async function loadBillingModifiers() {
            try {
                const response = await fetch('/api/billing_modifiers');
                if (!response.ok) throw new Error('Failed to load billing modifiers');
                
                allBillingModifiers = await response.json();
                console.log('‚úÖ Loaded billing modifiers:', allBillingModifiers.length);
            } catch (error) {
                console.error('‚ùå Error loading billing modifiers:', error);
                allBillingModifiers = [];
            }
        }

        // Add a new billing code row
        function addTypeBillingRow() {
            const tableBody = document.getElementById('type-billing-table-body');
            const row = document.createElement('tr');
            row.className = 'type-billing-entry';
            
            row.innerHTML = `
                <td style="padding: 5px; border: 1px solid #ddd;">
                    <input type="text" list="type-billing-codes-datalist" placeholder="Start typing code" 
                           style="width: 100%; border: none; outline: none;"
                           oninput="populateTypeBillingRow(this)">
                </td>
                <td style="padding: 5px; border: 1px solid #ddd; font-size: 0.9em;" class="description-cell">‚Äî</td>
                <td style="padding: 5px; border: 1px solid #ddd;">
                    <input type="number" value="1" min="1" style="width: 60px; border: none; outline: none;"
                           onchange="recalculateTypeBillingTotal(this)">
                </td>
                <td style="padding: 5px; border: 1px solid #ddd;">
                    <select style="width: 100%; border: none; outline: none;" onchange="applyTypeBillingModifier(this)">
                        <option value="">None</option>
                    </select>
                </td>
                <td style="padding: 5px; border: 1px solid #ddd; font-size: 0.9em;" class="rate-cell">‚Äî</td>
                <td style="padding: 5px; border: 1px solid #ddd; font-size: 0.9em; font-weight: bold;" class="total-cell">‚Äî</td>
                <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">
                    <button type="button" onclick="removeTypeBillingRow(this)" 
                            style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 2px 6px;">‚úï</button>
                </td>
            `;
            
            tableBody.appendChild(row);
            
            // Populate modifier dropdown
            const modifierSelect = row.querySelector('select');
            allBillingModifiers.forEach(modifier => {
                const option = document.createElement('option');
                option.value = modifier.code;
                option.textContent = `${modifier.code} - ${modifier.description}`;
                option.dataset.adjustmentFactor = modifier.adjustment_factor;
                modifierSelect.appendChild(option);
            });
            
            console.log('‚úÖ Added new billing code row');
        }

        // Remove a billing code row
        function removeTypeBillingRow(button) {
            const row = button.closest('tr');
            row.remove();
            recalculateTypeBillingTotal();
        }

        // Populate billing row when code is entered
        function populateTypeBillingRow(input) {
            const code = input.value;
            const row = input.closest('tr');
            const descriptionCell = row.querySelector('.description-cell');
            const rateCell = row.querySelector('.rate-cell');
            const totalCell = row.querySelector('.total-cell');
            const qtyInput = row.querySelector('input[type="number"]');
            
            const billingCode = allBillingCodes.find(bc => bc.code === code);
            if (billingCode) {
                descriptionCell.textContent = billingCode.description;
                rateCell.textContent = `R${billingCode.base_fee || '0'}`;
                
                // Calculate total
                const qty = parseInt(qtyInput.value) || 1;
                const rate = parseFloat(billingCode.base_fee) || 0;
                const total = qty * rate;
                totalCell.textContent = `R${total.toFixed(2)}`;
                
                recalculateTypeBillingTotal();
            } else {
                descriptionCell.textContent = '‚Äî';
                rateCell.textContent = '‚Äî';
                totalCell.textContent = '‚Äî';
            }
        }

        // Apply billing modifier
        function applyTypeBillingModifier(select) {
            const row = select.closest('tr');
            const rateCell = row.querySelector('.rate-cell');
            const totalCell = row.querySelector('.total-cell');
            const qtyInput = row.querySelector('input[type="number"]');
            const codeInput = row.querySelector('input[list]');
            
            const billingCode = allBillingCodes.find(bc => bc.code === codeInput.value);
            if (!billingCode) return;
            
            const modifier = allBillingModifiers.find(m => m.code === select.value);
            const adjustmentFactor = modifier ? parseFloat(modifier.adjustment_factor) : 1;
            const baseRate = parseFloat(billingCode.base_fee) || 0;
            const adjustedRate = baseRate * adjustmentFactor;
            
            rateCell.textContent = `R${adjustedRate.toFixed(2)}`;
            
            // Calculate total
            const qty = parseInt(qtyInput.value) || 1;
            const total = qty * adjustedRate;
            totalCell.textContent = `R${total.toFixed(2)}`;
            
            recalculateTypeBillingTotal();
        }

        // Recalculate total for billing table
        function recalculateTypeBillingTotal(changedInput) {
            // If a quantity changed, recalculate that row first
            if (changedInput) {
                const row = changedInput.closest('tr');
                const rateText = row.querySelector('.rate-cell').textContent;
                const rate = parseFloat(rateText.replace('R', '')) || 0;
                const qty = parseInt(changedInput.value) || 1;
                const total = qty * rate;
                row.querySelector('.total-cell').textContent = `R${total.toFixed(2)}`;
            }
            
            // Calculate overall total
            const totalCells = document.querySelectorAll('#type-billing-table-body .total-cell');
            let grandTotal = 0;
            
            totalCells.forEach(cell => {
                const amount = parseFloat(cell.textContent.replace('R', '')) || 0;
                grandTotal += amount;
            });
            
            document.getElementById('type-billing-total').textContent = `Total: R${grandTotal.toFixed(2)}`;
        }

        // Billing code info display is now handled by the table rows

        async function loadAppointmentTypes() {
            try {
                // Try the authenticated endpoint first
                let response = await fetch(`/api/practices/${currentPracticeId}/appointment-types/effective?enabled_only=false`);
                
                // If authentication fails, try alternative approaches
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('üîê Authentication required for practice endpoint, trying alternatives...');
                        
                        // Since all endpoints require auth, redirect to login
                        console.log('üîê All API endpoints require authentication');
                        window.location.href = '/login';
                        return;
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                
                appointmentTypes = await response.json();
                console.log(`‚úÖ Successfully loaded ${appointmentTypes.length} appointment types`);
                
                renderAppointmentTypes();
                updateCategoryDropdown();
                
                // Ensure all categories are expanded by default
                setTimeout(() => {
                    expandAllCategories();
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Error loading appointment types:', error);
                showError(`Failed to load appointment types: ${error.message}`);
                
                // Show helpful guidance
                const container = document.getElementById('appointment-types-container');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; background: #f9fafb; border-radius: 8px; border: 2px dashed #d1d5db;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üîê</div>
                            <h3 style="color: #374151; margin-bottom: 1rem;">Authentication Required</h3>
                            <p style="color: #6b7280; margin-bottom: 2rem;">This page requires authentication to load and manage appointment types.</p>
                            <a href="/login" style="background: #2D6356; color: white; padding: 1rem 2rem; border-radius: 8px; text-decoration: none; font-weight: 600;">
                                üîë Log In to Continue
                            </a>
                        </div>
                    `;
                }
            }
        }

        function renderAppointmentTypes() {
            const container = document.getElementById('appointment-types-container');
            
            console.log('üîç Rendering appointment types...', appointmentTypes.length, 'types loaded');
            console.log('üîç Raw appointmentTypes data:', appointmentTypes);
            
            // Group types by category
            const categories = new Map();
            
            appointmentTypes.forEach((type, index) => {
                console.log(`üîÑ Processing type ${index + 1}/${appointmentTypes.length}: ${type.name} (ID: ${type.id}, Parent: ${type.parent_id})`);
                console.log(`   üìù Type details:`, {
                    id: type.id,
                    name: type.name,
                    parent_id: type.parent_id,
                    color: type.color,
                    is_active: type.is_active,
                    duration: type.duration
                });
                
                if (!type.parent_id) {
                    // This is a category
                    if (!categories.has(type.id)) {
                        categories.set(type.id, {
                            ...type,
                            children: []
                        });
                        console.log(`‚úÖ Added category: ${type.name} (ID: ${type.id})`);
                    }
                } else {
                    // This is a child type
                    const parent = appointmentTypes.find(t => t.id === type.parent_id);
                    console.log(`üîç Looking for parent ID ${type.parent_id} for child ${type.name}`);
                    if (parent) {
                        if (!categories.has(parent.id)) {
                            categories.set(parent.id, {
                                ...parent,
                                children: []
                            });
                            console.log(`‚úÖ Added category from child: ${parent.name} (ID: ${parent.id})`);
                        }
                        categories.get(parent.id).children.push(type);
                        console.log(`‚úÖ Added child ${type.name} to category ${parent.name}. Category now has ${categories.get(parent.id).children.length} children`);
                    } else {
                        console.warn(`‚ö†Ô∏è Orphaned child type: ${type.name} (parent ID ${type.parent_id} not found)`);
                        console.warn(`   Available parent IDs:`, appointmentTypes.filter(t => !t.parent_id).map(t => t.id));
                    }
                }
            });
            
            console.log(`üìä Categories processed: ${categories.size}`);
            categories.forEach((category, id) => {
                console.log(`üìÅ Category: ${category.name} (ID: ${id}): ${category.children.length} children`);
                console.log(`   üìù Category details:`, {
                    id: category.id,
                    name: category.name,
                    color: category.color,
                    children_count: category.children.length,
                    children_names: category.children.map(c => c.name)
                });
            });

            // Render categories and their types
            container.innerHTML = '';
            
            if (categories.size === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No appointment types configured</h3>
                        <p>Click "Add Appointment Type" to create your first appointment type.</p>
                    </div>
                `;
                return;
            }

            console.log('üèóÔ∏è Starting to render category sections...');
            let categoryIndex = 0;
            categories.forEach(category => {
                categoryIndex++;
                console.log(`üèóÔ∏è Rendering category ${categoryIndex}/${categories.size}: ${category.name} with ${category.children.length} children`);
                
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section';
                console.log(`   üì¶ Created category section div for ${category.name}`);
                
                console.log(`üé® About to render template for category ${category.name} with ${category.children.length} children`);
                console.log(`üé® Children data:`, category.children);
                
                const childrenHtml = category.children.length > 0 ? category.children.map(type => {
                    console.log(`üé® Rendering child: ${type.name} (ID: ${type.id})`);
                    return `
                            <li class="appointment-type-item">
                                <div class="type-info">
                                    <div class="type-color-indicator" style="background-color: ${type.color || category.color}"></div>
                                    <span class="type-name">${type.name}</span>
                                    <div class="type-details">
                                        <span class="type-duration">
                                            <span class="material-icons" style="font-size: 14px; margin-right: 2px;">schedule</span>
                                            ${type.effective_duration || type.duration}min
                                        </span>
                                        ${(() => {
                                            // Handle both old single billing code and new array format
                                            const billingCodes = [];
                                            
                                            // Check for old format
                                            if (type.default_billing_code) {
                                                billingCodes.push(type.default_billing_code);
                                            }
                                            
                                            // Check for new array format
                                            if (type.default_billing_codes && Array.isArray(type.default_billing_codes)) {
                                                billingCodes.push(...type.default_billing_codes.map(bc => bc.code));
                                            }
                                            
                                            // Remove duplicates and return spans
                                            const uniqueCodes = [...new Set(billingCodes)];
                                            return uniqueCodes.map(code => `<span class="type-billing">
                                                <span class="material-icons" style="font-size: 14px; margin-right: 2px;">attach_money</span>
                                                ${code}
                                            </span>`).join('');
                                        })()}
                                        <span class="type-status ${type.is_active ? 'status-active' : 'status-inactive'}">
                                            <span class="material-icons" style="font-size: 14px; margin-right: 2px;">
                                                ${type.is_active ? 'check_circle' : 'cancel'}
                                            </span>
                                            ${type.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                    </div>
                                </div>
                                <div class="type-actions">
                                    <button class="btn-icon btn-edit" onclick="editAppointmentType(${type.id})" title="Edit">
                                        <span class="material-icons">edit</span>
                                    </button>
                                    <button class="btn-icon btn-toggle" onclick="toggleAppointmentType(${type.id}, ${!type.is_active})" 
                                            title="${type.is_active ? 'Deactivate' : 'Activate'}">
                                        <span class="material-icons">${type.is_active ? 'toggle_on' : 'toggle_off'}</span>
                                    </button>
                                    <button class="btn-icon btn-delete" onclick="deleteAppointmentType(${type.id})" title="Delete">
                                        <span class="material-icons">delete</span>
                                    </button>
                                </div>
                            </li>
                        `;
                }).join('') : '<li class="empty-state">No appointment types in this category</li>';
                
                console.log(`üé® Generated childrenHtml for ${category.name}:`, childrenHtml.substring(0, 200) + '...');
                
                categorySection.innerHTML = `
                    <div class="category-header" onclick="toggleCategoryExpansion(${category.id}, event)">
                        <div class="category-title" id="category-title-${category.id}">
                            <button class="category-expand-btn expanded" id="expand-btn-${category.id}">
                                <span class="material-icons">chevron_right</span>
                            </button>
                            <div class="category-color" style="background-color: ${category.color}"></div>
                            <span class="category-name">${category.name}</span>
                            <span class="category-count-badge ${category.children.length > 0 ? 'has-types' : ''}">${category.children.length}</span>
                        </div>
                        <div class="category-inline-edit" id="category-edit-${category.id}">
                            <input type="color" class="category-color-input" value="${category.color}">
                            <input type="text" class="category-name-input" value="${category.name}" 
                                   onkeypress="handleCategoryEditKeypress(event, ${category.id})">
                            <div class="category-edit-actions">
                                <button class="btn-category-save" onclick="saveCategoryEdit(${category.id})">Save</button>
                                <button class="btn-category-cancel" onclick="cancelCategoryEdit(${category.id})">Cancel</button>
                            </div>
                        </div>
                        <div class="category-actions" onclick="event.stopPropagation()">
                            <button class="btn-icon btn-reorder" title="Drag to reorder category" draggable="true" 
                                    onmousedown="startCategoryDrag(event, ${category.id})">
                                <span class="material-icons">drag_indicator</span>
                            </button>
                            <button class="btn-icon btn-edit" onclick="startCategoryEdit(${category.id})" title="Edit Category">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn-icon btn-delete" onclick="deleteCategory(${category.id})" title="Delete Category">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                    <ul class="appointment-type-list" id="type-list-${category.id}" style="display: block;">
                        ${childrenHtml}
                    </ul>
                    <div class="add-type-row" id="add-row-${category.id}" style="display: block;">
                        <div class="quick-add-container" id="quick-add-${category.id}" style="display: none;">
                            <div class="quick-add-form">
                                <input type="text" placeholder="Appointment type name" class="quick-add-input" 
                                       onkeypress="handleQuickAddKeypress(event, ${category.id})"
                                       maxlength="100">
                                <button class="btn-quick-save" onclick="saveQuickAdd(${category.id})">Save</button>
                                <button class="btn-quick-cancel" onclick="cancelQuickAdd(${category.id})">Cancel</button>
                            </div>
                        </div>
                        <div class="add-type-buttons" id="add-buttons-${category.id}">
                            <button class="btn-add-type-quick" onclick="showQuickAdd(${category.id})">
                                <span class="material-icons">add</span> Quick Add
                            </button>
                            <button class="btn-add-type" onclick="openCreateModal(${category.id})">
                                <span class="material-icons">settings</span> Advanced Add
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(categorySection);
                
                // Debug: Check if the appointment type list has the collapsed class
                const typeList = categorySection.querySelector(`#type-list-${category.id}`);
                console.log(`üîç Type list for ${category.name} has classes:`, typeList?.className);
                console.log(`üîç Type list display style:`, window.getComputedStyle(typeList).display);
            });
            
            console.log('‚úÖ All category sections rendered, container HTML length:', container.innerHTML.length);
        }

        function updateCategoryDropdown() {
            const select = document.getElementById('type-category');
            const currentValue = select.value;
            
            // Clear existing options except first two
            while (select.options.length > 2) {
                select.remove(2);
            }
            
            // Add categories
            const categories = appointmentTypes.filter(t => !t.parent_id);
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
            
            // Restore previous value if it exists
            if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                select.value = currentValue;
            }
        }

        function openCreateModal(categoryId = null) {
            editingTypeId = null;
            
            // Set modal title based on whether adding to specific category
            const modalTitle = document.getElementById('modal-title');
            if (categoryId) {
                const category = appointmentTypes.find(t => t.id === categoryId);
                const categoryName = category ? category.name : 'Category';
                modalTitle.textContent = `Add Appointment Type to ${categoryName}`;
            } else {
                modalTitle.textContent = 'Create Appointment Type';
            }
            
            document.getElementById('appointment-type-form').reset();
            document.getElementById('type-status').value = 'active';
            document.getElementById('type-billable').checked = true;
            
            if (categoryId) {
                document.getElementById('type-category').value = categoryId;
                // Use category color as default
                const category = appointmentTypes.find(t => t.id === categoryId);
                if (category && category.color) {
                    document.getElementById('type-color').value = category.color;
                    document.getElementById('color-preview').style.backgroundColor = category.color;
                } else {
                    document.getElementById('color-preview').style.backgroundColor = '#2D6356';
                }
            } else {
                document.getElementById('color-preview').style.backgroundColor = '#2D6356';
            }
            
            document.getElementById('appointment-type-modal').classList.add('active');
        }

        async function editAppointmentType(typeId) {
            const type = appointmentTypes.find(t => t.id === typeId);
            if (!type) return;
            
            editingTypeId = typeId;
            document.getElementById('modal-title').textContent = 'Edit Appointment Type';
            document.getElementById('type-id').value = type.id;
            document.getElementById('type-name').value = type.name;
            document.getElementById('type-category').value = type.parent_id || '';
            document.getElementById('type-duration').value = type.duration;
            document.getElementById('type-color').value = type.color;
            document.getElementById('color-preview').style.backgroundColor = type.color;
            // Clear and populate billing codes table
            document.getElementById('type-billing-table-body').innerHTML = '';
            if (type.default_billing_codes && type.default_billing_codes.length > 0) {
                type.default_billing_codes.forEach(billingCode => {
                    addTypeBillingRow();
                    const lastRow = document.querySelector('#type-billing-table-body tr:last-child');
                    const codeInput = lastRow.querySelector('input[list]');
                    const qtyInput = lastRow.querySelector('input[type="number"]');
                    const modifierSelect = lastRow.querySelector('select');
                    
                    codeInput.value = billingCode.code;
                    qtyInput.value = billingCode.quantity || 1;
                    if (billingCode.modifier) {
                        modifierSelect.value = billingCode.modifier;
                    }
                    
                    populateTypeBillingRow(codeInput);
                    if (billingCode.modifier) {
                        applyTypeBillingModifier(modifierSelect);
                    }
                });
            } else {
                // Add one empty row if no billing codes exist
                addTypeBillingRow();
            }
            
            document.getElementById('type-default-notes').value = type.default_notes || '';
            document.getElementById('type-description').value = type.description || '';
            document.getElementById('type-sort-order').value = type.sort_order || 0;
            document.getElementById('type-status').value = type.is_active ? 'active' : 'inactive';
            document.getElementById('type-requires-auth').checked = type.requires_authorization || false;
            document.getElementById('type-billable').checked = type.is_billable !== false;
            
            document.getElementById('appointment-type-modal').classList.add('active');
        }

        function editCategory(categoryId) {
            // For now, edit category as a regular type
            editAppointmentType(categoryId);
        }

        function closeModal() {
            document.getElementById('appointment-type-modal').classList.remove('active');
            document.getElementById('appointment-type-form').reset();
            editingTypeId = null;
        }

        async function saveAppointmentType() {
            const form = document.getElementById('appointment-type-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const categorySelect = document.getElementById('type-category');
            let parentId = categorySelect.value;
            
            // Handle new category creation
            if (parentId === 'new') {
                const newCategoryName = document.getElementById('new-category-name').value.trim();
                if (!newCategoryName) {
                    alert('Please enter a category name');
                    return;
                }
                
                // Create the new category first
                try {
                    const categoryResponse = await fetch('/api/appointment-types', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: newCategoryName,
                            parent_id: null,
                            practice_id: currentPracticeId,
                            color: document.getElementById('type-color').value,
                            duration: 30,
                            is_active: true
                        })
                    });
                    
                    if (!categoryResponse.ok) throw new Error('Failed to create category');
                    const newCategory = await categoryResponse.json();
                    parentId = newCategory.id;
                } catch (error) {
                    console.error('Error creating category:', error);
                    showError('Failed to create category');
                    return;
                }
            }
            
            const typeData = {
                name: document.getElementById('type-name').value.trim(),
                parent_id: parentId ? parseInt(parentId) : null,
                practice_id: currentPracticeId,
                color: document.getElementById('type-color').value,
                duration: parseInt(document.getElementById('type-duration').value),
                description: document.getElementById('type-description').value.trim() || null,
                is_active: document.getElementById('type-status').value === 'active'
            };
            
            // Collect billing codes data
            const billingCodes = [];
            const billingRows = document.querySelectorAll('#type-billing-table-body tr');
            billingRows.forEach(row => {
                const codeInput = row.querySelector('input[list]');
                const qtyInput = row.querySelector('input[type="number"]');
                const modifierSelect = row.querySelector('select');
                
                if (codeInput.value.trim()) {
                    billingCodes.push({
                        code: codeInput.value.trim(),
                        quantity: parseInt(qtyInput.value) || 1,
                        modifier: modifierSelect.value || null
                    });
                }
            });
            
            // Add practice customization data
            const customizationData = {
                appointment_type_id: editingTypeId,
                practice_id: currentPracticeId,
                enabled: typeData.is_active,
                effective_duration: typeData.duration,
                effective_color: typeData.color,
                default_billing_codes: billingCodes,
                default_notes: document.getElementById('type-default-notes').value.trim() || null,
                sort_order: parseInt(document.getElementById('type-sort-order').value) || 0,
                requires_authorization: document.getElementById('type-requires-auth').checked,
                is_billable: document.getElementById('type-billable').checked
            };
            
            try {
                let response;
                
                if (editingTypeId) {
                    // Update existing type
                    response = await fetch(`/api/appointment-types/${editingTypeId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(typeData)
                    });
                    
                    // Also update practice customization
                    if (response.ok) {
                        // First, find the customization ID for this appointment type
                        const customizationsResponse = await fetch(`/api/practices/${currentPracticeId}/appointment-types/customizations`);
                        const customizations = await customizationsResponse.json();
                        const existingCustomization = customizations.find(c => c.appointment_type_id === editingTypeId);
                        
                        if (existingCustomization) {
                            // Update existing customization
                            await fetch(`/api/practices/${currentPracticeId}/appointment-types/customizations/${existingCustomization.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(customizationData)
                            });
                        } else {
                            // Create new customization
                            await fetch(`/api/practices/${currentPracticeId}/appointment-types/customizations`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(customizationData)
                            });
                        }
                    }
                } else {
                    // Create new type
                    response = await fetch('/api/appointment-types', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(typeData)
                    });
                    
                    // Create practice customization
                    if (response.ok) {
                        const newType = await response.json();
                        customizationData.appointment_type_id = newType.id;
                        
                        await fetch(`/api/practices/${currentPracticeId}/appointment-types/customizations`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(customizationData)
                        });
                    }
                }
                
                if (!response.ok) throw new Error('Failed to save appointment type');
                
                showSuccess('Appointment type saved successfully');
                closeModal();
                loadAppointmentTypes();
            } catch (error) {
                console.error('Error saving appointment type:', error);
                showError('Failed to save appointment type');
            }
        }

        async function toggleAppointmentType(typeId, activate) {
            try {
                const response = await fetch(`/api/appointment-types/${typeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: activate })
                });
                
                if (!response.ok) throw new Error('Failed to update appointment type');
                
                showSuccess(`Appointment type ${activate ? 'activated' : 'deactivated'}`);
                loadAppointmentTypes();
            } catch (error) {
                console.error('Error toggling appointment type:', error);
                showError('Failed to update appointment type');
            }
        }

        async function deleteAppointmentType(typeId) {
            if (!confirm('Are you sure you want to delete this appointment type?')) return;
            
            try {
                const response = await fetch(`/api/appointment-types/${typeId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete appointment type');
                
                showSuccess('Appointment type deleted');
                loadAppointmentTypes();
            } catch (error) {
                console.error('Error deleting appointment type:', error);
                showError('Failed to delete appointment type');
            }
        }

        async function deleteCategory(categoryId) {
            const category = appointmentTypes.find(t => t.id === categoryId);
            const hasChildren = appointmentTypes.some(t => t.parent_id === categoryId);
            
            if (hasChildren) {
                if (!confirm(`The category "${category.name}" contains appointment types. Deleting it will also delete all types within it. Continue?`)) {
                    return;
                }
            } else {
                if (!confirm(`Are you sure you want to delete the category "${category.name}"?`)) {
                    return;
                }
            }
            
            try {
                const response = await fetch(`/api/appointment-types/${categoryId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete category');
                
                showSuccess('Category deleted');
                loadAppointmentTypes();
            } catch (error) {
                console.error('Error deleting category:', error);
                showError('Failed to delete category');
            }
        }

        function showSuccess(message) {
            // Simple success notification - can be enhanced with a toast library
            const toast = document.createElement('div');
            toast.className = 'toast-success';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-error';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ef4444;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Quick Add Functionality
        function showQuickAdd(categoryId) {
            const quickAddContainer = document.getElementById(`quick-add-${categoryId}`);
            const buttonsContainer = document.getElementById(`add-buttons-${categoryId}`);
            
            if (quickAddContainer && buttonsContainer) {
                quickAddContainer.style.display = 'block';
                buttonsContainer.style.display = 'none';
                
                // Focus on the input
                const input = quickAddContainer.querySelector('.quick-add-input');
                if (input) {
                    input.focus();
                    input.value = ''; // Clear any previous value
                }
            }
        }
        
        function cancelQuickAdd(categoryId) {
            const quickAddContainer = document.getElementById(`quick-add-${categoryId}`);
            const buttonsContainer = document.getElementById(`add-buttons-${categoryId}`);
            
            if (quickAddContainer && buttonsContainer) {
                quickAddContainer.style.display = 'none';
                buttonsContainer.style.display = 'flex';
                
                // Clear the input
                const input = quickAddContainer.querySelector('.quick-add-input');
                if (input) {
                    input.value = '';
                }
            }
        }
        
        function handleQuickAddKeypress(event, categoryId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveQuickAdd(categoryId);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                cancelQuickAdd(categoryId);
            }
        }
        
        async function saveQuickAdd(categoryId) {
            const quickAddContainer = document.getElementById(`quick-add-${categoryId}`);
            const input = quickAddContainer?.querySelector('.quick-add-input');
            
            if (!input) {
                showError('Could not find input field');
                return;
            }
            
            const typeName = input.value.trim();
            if (!typeName) {
                showError('Please enter an appointment type name');
                input.focus();
                return;
            }
            
            try {
                // Find the category to get its color
                const category = appointmentTypes.find(t => t.id === categoryId);
                const categoryColor = category ? category.color : '#2D6356';
                
                // Create the appointment type with minimal required fields
                const typeData = {
                    name: typeName,
                    parent_id: categoryId,
                    practice_id: currentPracticeId,
                    color: categoryColor, // Use category color as default
                    duration: 30, // Default duration
                    is_active: true
                };
                
                // Show loading state
                input.disabled = true;
                const saveBtn = quickAddContainer.querySelector('.btn-quick-save');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'Saving...';
                
                // Create the appointment type
                const response = await fetch('/api/appointment-types', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(typeData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const newType = await response.json();
                
                // Create practice customization with default settings
                const customizationData = {
                    appointment_type_id: newType.id,
                    practice_id: currentPracticeId,
                    enabled: true,
                    effective_duration: 30,
                    effective_color: categoryColor,
                    default_billing_codes: [],
                    default_notes: null,
                    sort_order: 0,
                    requires_authorization: false,
                    is_billable: true
                };
                
                await fetch(`/api/practices/${currentPracticeId}/appointment-types/customizations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customizationData)
                });
                
                // Success!
                showSuccess(`"${typeName}" added to category successfully`);
                cancelQuickAdd(categoryId);
                loadAppointmentTypes(); // Reload to show the new type
                
            } catch (error) {
                console.error('Error in quick add:', error);
                showError(`Failed to add appointment type: ${error.message}`);
                
                // Reset the form state
                input.disabled = false;
                const saveBtn = quickAddContainer.querySelector('.btn-quick-save');
                saveBtn.textContent = originalText;
                input.focus();
            }
        }
        
        // Category Management Functions
        function startCategoryEdit(categoryId) {
            const titleDiv = document.getElementById(`category-title-${categoryId}`);
            const editDiv = document.getElementById(`category-edit-${categoryId}`);
            
            if (titleDiv && editDiv) {
                titleDiv.style.display = 'none';
                editDiv.style.display = 'flex';
                
                // Focus on the name input
                const nameInput = editDiv.querySelector('.category-name-input');
                if (nameInput) {
                    nameInput.focus();
                    nameInput.select();
                }
            }
        }
        
        function cancelCategoryEdit(categoryId) {
            const titleDiv = document.getElementById(`category-title-${categoryId}`);
            const editDiv = document.getElementById(`category-edit-${categoryId}`);
            
            if (titleDiv && editDiv) {
                titleDiv.style.display = 'flex';
                editDiv.style.display = 'none';
                
                // Reset the input values to original
                const category = appointmentTypes.find(t => t.id === categoryId);
                if (category) {
                    const nameInput = editDiv.querySelector('.category-name-input');
                    const colorInput = editDiv.querySelector('.category-color-input');
                    if (nameInput) nameInput.value = category.name;
                    if (colorInput) colorInput.value = category.color;
                }
            }
        }
        
        function handleCategoryEditKeypress(event, categoryId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveCategoryEdit(categoryId);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                cancelCategoryEdit(categoryId);
            }
        }
        
        async function saveCategoryEdit(categoryId) {
            const editDiv = document.getElementById(`category-edit-${categoryId}`);
            if (!editDiv) return;
            
            const nameInput = editDiv.querySelector('.category-name-input');
            const colorInput = editDiv.querySelector('.category-color-input');
            
            if (!nameInput || !colorInput) {
                showError('Could not find edit inputs');
                return;
            }
            
            const newName = nameInput.value.trim();
            const newColor = colorInput.value;
            
            if (!newName) {
                showError('Category name cannot be empty');
                nameInput.focus();
                return;
            }
            
            try {
                // Show loading state
                const saveBtn = editDiv.querySelector('.btn-category-save');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'Saving...';
                saveBtn.disabled = true;
                
                // Update the category
                const response = await fetch(`/api/appointment-types/${categoryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName,
                        color: newColor
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Success!
                showSuccess(`Category "${newName}" updated successfully`);
                cancelCategoryEdit(categoryId);
                loadAppointmentTypes(); // Reload to show the changes
                
            } catch (error) {
                console.error('Error saving category:', error);
                showError(`Failed to update category: ${error.message}`);
                
                // Reset button state
                const saveBtn = editDiv.querySelector('.btn-category-save');
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }
        
        // Replace the old editCategory function with the new inline editing
        function editCategory(categoryId) {
            startCategoryEdit(categoryId);
        }
        
        // Category Drag and Drop Functions
        let draggedCategoryId = null;
        let draggedElement = null;
        
        function startCategoryDrag(event, categoryId) {
            draggedCategoryId = categoryId;
            draggedElement = event.target.closest('.category-section');
            
            if (draggedElement) {
                draggedElement.classList.add('dragging');
                
                // Set up drag events
                draggedElement.addEventListener('dragstart', handleCategoryDragStart);
                draggedElement.addEventListener('dragend', handleCategoryDragEnd);
                
                // Add drop zones to all category sections
                const allCategories = document.querySelectorAll('.category-section');
                allCategories.forEach(cat => {
                    cat.addEventListener('dragover', handleCategoryDragOver);
                    cat.addEventListener('drop', handleCategoryDrop);
                    cat.addEventListener('dragleave', handleCategoryDragLeave);
                });
            }
        }
        
        function handleCategoryDragStart(event) {
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', draggedCategoryId);
        }
        
        function handleCategoryDragEnd(event) {
            // Clean up drag styles
            const allCategories = document.querySelectorAll('.category-section');
            allCategories.forEach(cat => {
                cat.classList.remove('dragging', 'drag-over');
                cat.removeEventListener('dragover', handleCategoryDragOver);
                cat.removeEventListener('drop', handleCategoryDrop);
                cat.removeEventListener('dragleave', handleCategoryDragLeave);
            });
            
            draggedCategoryId = null;
            draggedElement = null;
        }
        
        function handleCategoryDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const targetCategory = event.currentTarget;
            if (targetCategory !== draggedElement) {
                targetCategory.classList.add('drag-over');
            }
        }
        
        function handleCategoryDragLeave(event) {
            const targetCategory = event.currentTarget;
            targetCategory.classList.remove('drag-over');
        }
        
        function handleCategoryDrop(event) {
            event.preventDefault();
            
            const targetCategory = event.currentTarget;
            const targetCategoryId = extractCategoryIdFromElement(targetCategory);
            
            if (draggedCategoryId && targetCategoryId && draggedCategoryId !== targetCategoryId) {
                reorderCategories(draggedCategoryId, targetCategoryId);
            }
            
            targetCategory.classList.remove('drag-over');
        }
        
        function extractCategoryIdFromElement(element) {
            // Extract category ID from the element's HTML content
            const editButton = element.querySelector('[onclick*="startCategoryEdit"]');
            if (editButton) {
                const onclickValue = editButton.getAttribute('onclick');
                const match = onclickValue.match(/startCategoryEdit\\((\\d+)\\)/);
                return match ? parseInt(match[1]) : null;
            }
            return null;
        }
        
        async function reorderCategories(draggedId, targetId) {
            try {
                // For now, we'll implement a simple swap
                // In a more complex implementation, you might want to track sort_order in the database
                showSuccess(`Category reordering: ${draggedId} ‚Üí ${targetId} (implementation pending)`);
                
                // TODO: Implement actual reordering API call
                // This would involve updating sort_order values in the database
                // and then reloading the appointment types
                
            } catch (error) {
                console.error('Error reordering categories:', error);
                showError('Failed to reorder categories');
            }
        }
        
        // Category Expand/Collapse Functions
        function toggleCategoryExpansion(categoryId, event) {
            // Prevent event bubbling if clicking on other elements
            if (event && (event.target.closest('.category-actions') || event.target.closest('.category-inline-edit'))) {
                return;
            }
            
            const expandBtn = document.getElementById(`expand-btn-${categoryId}`);
            const typeList = document.getElementById(`type-list-${categoryId}`);
            const addRow = document.getElementById(`add-row-${categoryId}`);
            
            if (expandBtn && typeList && addRow) {
                const isExpanded = expandBtn.classList.contains('expanded');
                
                if (isExpanded) {
                    // Collapse
                    expandBtn.classList.remove('expanded');
                    typeList.classList.add('collapsed');
                    addRow.classList.add('collapsed');
                } else {
                    // Expand
                    expandBtn.classList.add('expanded');
                    typeList.classList.remove('collapsed');
                    addRow.classList.remove('collapsed');
                }
            }
        }
        
        // Expand all categories by default when page loads
        function expandAllCategories() {
            console.log('üîß Expanding all categories...');
            const expandBtns = document.querySelectorAll('.category-expand-btn');
            console.log(`üîç Found ${expandBtns.length} expand buttons`);
            expandBtns.forEach((btn, index) => {
                console.log(`üîç Button ${index + 1}: ID=${btn.id}, classes=${btn.className}`);
                if (!btn.classList.contains('expanded')) {
                    const categoryId = btn.id.replace('expand-btn-', '');
                    console.log(`üîß Expanding category ${categoryId}`);
                    toggleCategoryExpansion(categoryId);
                } else {
                    console.log(`‚úÖ Button ${index + 1} is already expanded`);
                }
            });
        }
    </script>
    
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</body>
</html>