<!-- Report Request Modal - Supports both manager and therapist workflows -->
<div id="report-request-modal" class="modal unified-modal" style="display: none;">
    <div class="modal-content large-modal">
        <!-- Modal Header with Progress Indicator -->
        <div class="modal-header">
            <h3 id="report-modal-title">Create Report Request</h3>
            <div class="progress-indicator">
                <span class="step active" data-step="1">
                    <span class="step-number">1</span>
                    <span class="step-label">Details</span>
                </span>
                <div class="step-connector"></div>
                <span class="step" data-step="2">
                    <span class="step-number">2</span>
                    <span class="step-label">AI Content</span>
                </span>
            </div>
            <span class="close-button" id="close-report-modal">&times;</span>
        </div>
        
        <!-- Modal Body -->
        <div class="modal-body">
            
            <!-- Step 1: Report Details -->
            <div id="report-details-step" class="modal-step active">
                <div class="step-content">
                    
                    <!-- Workflow Type Indicator -->
                    <div class="workflow-indicator">
                        <div id="manager-workflow-indicator" class="workflow-badge manager-workflow" style="display: none;">
                            <span class="workflow-icon">üë®‚Äçüíº</span>
                            <span>Manager Request</span>
                        </div>
                        <div id="therapist-workflow-indicator" class="workflow-badge therapist-workflow" style="display: none;">
                            <span class="workflow-icon">üë©‚Äç‚öïÔ∏è</span>
                            <span>Self Request</span>
                        </div>
                    </div>
                    
                    <form id="report-request-form">
                        <!-- Hidden fields -->
                        <input type="hidden" id="editing-report-id" />
                        <input type="hidden" id="workflow-type" />
                        <input type="hidden" id="requested-by-user-id" />
                        
                        <!-- Report Basic Information -->
                        <div class="form-section">
                            <h4>Report Information</h4>
                            
                            <div class="form-group">
                                <label for="report-patient-select">Patient *</label>
                                <div class="patient-selection">
                                    <select id="report-patient-select" required>
                                        <option value="">Select a patient...</option>
                                    </select>
                                    <button type="button" class="btn-secondary" onclick="openReportPatientSearch()">Search</button>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="report-type-select">Report Type *</label>
                                    <select id="report-type-select" required>
                                        <option value="">Select report type...</option>
                                        <option value="progress">Progress Report</option>
                                        <option value="discharge">Discharge Report</option>
                                        <option value="insurance">Insurance Report</option>
                                        <option value="outcome_summary">Outcome Summary</option>
                                        <option value="multi_disciplinary">Multi-disciplinary Assessment</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="report-template-select">Template *</label>
                                    <select id="report-template-select" required>
                                        <option value="">Select template...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="report-title-input">Report Title *</label>
                                <input type="text" id="report-title-input" placeholder="e.g., Progress Report - [Patient Name] - [Date]" required />
                                <button type="button" class="btn-secondary auto-title-btn" onclick="generateReportTitle()">Auto-Generate</button>
                            </div>
                        </div>
                        
                        <!-- Assignment and Workflow -->
                        <div class="form-section">
                            <h4>Assignment & Disciplines</h4>
                            
                            <div class="form-group">
                                <label for="assigned-therapists">Assigned Therapists *</label>
                                <div class="therapist-assignment">
                                    <select id="assigned-therapists" multiple required>
                                        <!-- Options populated by JavaScript -->
                                    </select>
                                    <div class="assignment-note">
                                        <small id="self-assignment-note" style="display: none;">
                                            <span class="field-indicator auto-populated">üë§</span>
                                            You are automatically assigned to this report
                                        </small>
                                        <small id="manager-assignment-note" style="display: none;">
                                            Select therapists to assign this report to
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="report-disciplines">Involved Disciplines *</label>
                                <div class="inline-discipline-selector-wrapper">
                                    <div class="discipline-selector-preview" id="report-disciplines-preview">
                                        <p class="empty-preview">No disciplines selected. Click "Select Disciplines" to choose.</p>
                                    </div>
                                    <div class="discipline-selector-actions">
                                        <button type="button" class="btn btn-outline btn-sm" onclick="openDisciplineSelectorForReport()">
                                            <i class="fas fa-plus"></i> Select Disciplines
                                        </button>
                                        <button type="button" class="btn btn-outline btn-sm" onclick="autoDetectDisciplinesForReport()">
                                            <i class="fas fa-magic"></i> Auto-Detect
                                        </button>
                                    </div>
                                </div>
                                <small class="field-note">
                                    <span class="field-indicator auto-generated">ü§ñ</span>
                                    Auto-detection analyzes patient data and symptoms to suggest relevant disciplines
                                </small>
                            </div>
                        </div>
                        
                        <!-- Priority and Timeline -->
                        <div class="form-section">
                            <h4>Priority & Timeline</h4>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="report-priority">Priority Level *</label>
                                    <select id="report-priority" required>
                                        <option value="1">Low Priority</option>
                                        <option value="2" selected>Normal Priority</option>
                                        <option value="3">High Priority</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="report-deadline">Deadline</label>
                                    <input type="date" id="report-deadline" />
                                    <div class="deadline-suggestions">
                                        <button type="button" class="deadline-btn" onclick="setDeadline(7)">1 week</button>
                                        <button type="button" class="deadline-btn" onclick="setDeadline(14)">2 weeks</button>
                                        <button type="button" class="deadline-btn" onclick="setDeadline(30)">1 month</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </form>
                </div>
            </div>
            
            <!-- Step 2: AI Content Options -->
            <div id="ai-content-step" class="modal-step">
                <div class="step-content">
                    <h4>AI Content Generation</h4>
                    
                    <div class="ai-content-options">
                        <div class="ai-option">
                            <input type="checkbox" id="generate-medical-history" checked />
                            <label for="generate-medical-history">
                                <strong>Generate Medical History</strong>
                                <small>AI will compile medical history from treatment notes and assessments</small>
                            </label>
                        </div>
                        
                        <div class="ai-option">
                            <input type="checkbox" id="generate-treatment-summary" checked />
                            <label for="generate-treatment-summary">
                                <strong>Generate Treatment Summary</strong>
                                <small>AI will create a comprehensive treatment summary across disciplines</small>
                            </label>
                        </div>
                        
                        <div class="ai-option">
                            <input type="checkbox" id="generate-outcome-analysis" />
                            <label for="generate-outcome-analysis">
                                <strong>Generate Outcome Analysis</strong>
                                <small>AI will analyze outcome measures and progress indicators</small>
                            </label>
                        </div>
                    </div>
                    
                    <div class="ai-content-preview" style="display: none;">
                        <h5>AI Content Preview</h5>
                        <div class="content-preview">
                            <div class="preview-section">
                                <h6>Medical History Preview</h6>
                                <div class="preview-content" id="medical-history-preview">
                                    <!-- AI generated preview will appear here -->
                                </div>
                            </div>
                            <div class="preview-section">
                                <h6>Treatment Summary Preview</h6>
                                <div class="preview-content" id="treatment-summary-preview">
                                    <!-- AI generated preview will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ai-generation-status" style="display: none;">
                        <div class="status-indicator">
                            <div class="spinner"></div>
                            <span id="generation-status-text">Generating AI content...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- Modal Footer with Navigation -->
        <div class="modal-footer">
            <button id="report-back-button" class="btn btn-secondary" style="display: none;">
                ‚Üê Back to Details
            </button>
            <button id="report-continue-button" class="btn btn-primary" disabled>
                Continue to AI Content ‚Üí
            </button>
            <button id="preview-ai-content-button" class="btn btn-secondary" style="display: none;">
                Preview AI Content
            </button>
            <button id="create-report-button" class="btn btn-primary" style="display: none;">
                Create Report
            </button>
            <button id="report-cancel-button" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<!-- Modal Backdrop -->
<div id="report-request-modal-backdrop" class="modal-backdrop" style="display: none;"></div>

<!-- Patient Search Modal for Reports -->
<div id="report-patient-search-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Search Patients</h3>
            <span class="close-button" onclick="closeReportPatientSearch()">&times;</span>
        </div>
        <div class="modal-body">
            <input type="text" id="report-patient-search-input" placeholder="Search by name, ID number, or phone..." />
            <div id="report-patient-search-results">
                <!-- Search results will be populated here -->
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeReportPatientSearch()" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>